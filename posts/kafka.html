<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.18" />
    <style>
      :root {
        --vp-c-bg: #fff;
      }

      [data-theme='dark'] {
        --vp-c-bg: #1b1b1f;
      }

      html,
      body {
        background-color: var(--vp-c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme')
      const systemDarkMode =
        'matchMedia' in window
          ? window.matchMedia('(prefers-color-scheme: dark)').matches
          : false

      if (userMode === 'light') {
        document.documentElement.dataset.theme = 'light'
      } else if (userMode === 'dark' || systemDarkMode) {
        document.documentElement.dataset.theme = 'dark'
      }
    </script>
    <title>Kafka | 水木</title><meta name="description" content="欢迎来到我的空间。">
    <link rel="preload" href="/blog/assets/style-BraDacIo.css" as="style"><link rel="stylesheet" href="/blog/assets/style-BraDacIo.css">
    <link rel="modulepreload" href="/blog/assets/app-B6K0T__V.js"><link rel="modulepreload" href="/blog/assets/kafka.html-DOKItB-c.js">
    <link rel="prefetch" href="/blog/assets/index.html-DVWxlgcq.js" as="script"><link rel="prefetch" href="/blog/assets/scheduler.html-Drp__yoa.js" as="script"><link rel="prefetch" href="/blog/assets/Hbase.html-DvZ58706.js" as="script"><link rel="prefetch" href="/blog/assets/flink-to-clickHouse.html-DBxdG-y6.js" as="script"><link rel="prefetch" href="/blog/assets/ES.html-B-0MHbOn.js" as="script"><link rel="prefetch" href="/blog/assets/Rocket.html-_nH3SeUB.js" as="script"><link rel="prefetch" href="/blog/assets/mysql.html-CtUzXauf.js" as="script"><link rel="prefetch" href="/blog/assets/Redisson.html-Bx6FAVFm.js" as="script"><link rel="prefetch" href="/blog/assets/redis.html-CmvfnVrM.js" as="script"><link rel="prefetch" href="/blog/assets/Zookeeper.html-E7k0hsdB.js" as="script"><link rel="prefetch" href="/blog/assets/404.html-D3ew3pPH.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-C-TNVO7u.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-DJkMpyD6.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-DZlQ2OIp.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-BEyGzpjh.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-CHIkBikE.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-Bio7xUaL.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-CmcSPK7G.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-BlebrQak.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-BNc27vfx.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-Ecd0iGwe.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-DWlVt83P.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-aJVo2Oli.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-0GHc2cMg.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-udISkAL3.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-uTUzK7xS.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-BJr_NcJc.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-KgIT-O3n.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-DkPTyIOo.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-x1GFYEdj.js" as="script"><link rel="prefetch" href="/blog/assets/setupDevtools-7MC2TMWH-hcQrRGMC.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><div class="vp-theme-container external-link-icon" vp-container><!--[--><header class="vp-navbar" vp-navbar><div class="vp-toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a class="route-link" href="/blog/"><img class="vp-site-logo" src="/blog/logo.jpg" alt="水木"><span class="vp-site-name vp-hide-mobile" aria-hidden="true">水木</span></a></span><div class="vp-navbar-items-wrapper" style=""><!--[--><!--]--><nav class="vp-navbar-items vp-hide-mobile" aria-label="site navigation"><!--[--><div class="vp-navbar-item"><a class="route-link auto-link" href="/blog/" aria-label="首页"><!---->首页<!----></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/blog/article/" aria-label="文章"><!---->文章<!----></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/blog/tag/" aria-label="标签"><!---->标签<!----></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/blog/category/" aria-label="分类"><!---->分类<!----></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/blog/timeline/" aria-label="时间线"><!---->时间线<!----></a></div><!--]--></nav><!--[--><!--]--><button type="button" class="vp-toggle-color-mode-button" title="toggle color mode"><svg class="light-icon" viewbox="0 0 32 32" style=""><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg class="dark-icon" viewbox="0 0 32 32" style="display:none;"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!----></div></header><!--]--><div class="vp-sidebar-mask"></div><!--[--><aside class="vp-sidebar" vp-sidebar><nav class="vp-navbar-items" aria-label="site navigation"><!--[--><div class="vp-navbar-item"><a class="route-link auto-link" href="/blog/" aria-label="首页"><!---->首页<!----></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/blog/article/" aria-label="文章"><!---->文章<!----></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/blog/tag/" aria-label="标签"><!---->标签<!----></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/blog/category/" aria-label="分类"><!---->分类<!----></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/blog/timeline/" aria-label="时间线"><!---->时间线<!----></a></div><!--]--></nav><!--[--><!--]--><ul class="vp-sidebar-items"><!--[--><li><p tabindex="0" class="vp-sidebar-item vp-sidebar-heading">Kafka <!----></p><!----></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="vp-page"><!--[--><!--]--><div class="theme-default-content" vp-content><!--[--><!--]--><div><h2 id="kafka简介" tabindex="-1"><a class="header-anchor" href="#kafka简介"><span>Kafka简介：</span></a></h2><p>Kafka是最初由Linkedin公司开发，是一个分布式、支持分区的（partition）、多副本的（replica），基于zookeeper协调的分布式消息系统，它的最大的特性就是可以实时的处理大量数据以满足各种需求场景：比如基于hadoop的批处理系统、低延迟的实时系统、Storm/Spark流式处理引擎，web/nginx日志、访问日志，消息服务等等，用scala语言编写，Linkedin于2010年贡献给了Apache基金会并成为顶级开源 项目。</p><h2 id="安装维护" tabindex="-1"><a class="header-anchor" href="#安装维护"><span>安装维护</span></a></h2><h3 id="命令操作" tabindex="-1"><a class="header-anchor" href="#命令操作"><span>命令操作</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token comment"># zk 安装</span></span>
<span class="line"><span class="token function">wget</span> https://mirror.bit.edu.cn/apache/zookeeper/zookeeper‐3.5.8/apache‐zookeeper‐3.5.8‐bin.tar.gz </span>
<span class="line"><span class="token function">tar</span> ‐zxvf apache‐zookeeper‐3.5.8‐bin.tar.gz</span>
<span class="line"><span class="token builtin class-name">cd</span> apache‐zookeeper‐3.5.8‐bin </span>
<span class="line"><span class="token function">cp</span> conf/zoo_sample.cfg conf/zoo.cfg </span>
<span class="line"><span class="token comment"># 启动zookeeper </span></span>
<span class="line">bin/zkServer.sh start </span>
<span class="line">bin/zkCli.sh </span>
<span class="line"><span class="token comment">#查看zk的根目录相关节点</span></span>
<span class="line"><span class="token function">ls</span> / </span>
<span class="line"></span>
<span class="line"><span class="token comment"># kafka 安装</span></span>
<span class="line"><span class="token comment"># 2.11是scala的版本，2.4.1是kafka的版本 </span></span>
<span class="line"><span class="token function">wget</span> https://mirror.bit.edu.cn/apache/kafka/2.4.1/kafka_2.11‐2.4.1.tgz </span>
<span class="line"><span class="token function">tar</span> ‐xzf kafka_2.11‐2.4.1.tgz </span>
<span class="line"><span class="token builtin class-name">cd</span> kafka_2.11‐2.4.1</span>
<span class="line"><span class="token comment">#broker.id属性在kafka集群中必须要是唯一 </span></span>
<span class="line"><span class="token assign-left variable">broker.id</span><span class="token operator">=</span><span class="token number">0</span> </span>
<span class="line"><span class="token comment">#kafka部署的机器ip和提供服务的端口号</span></span>
<span class="line"><span class="token assign-left variable">listeners</span><span class="token operator">=</span>PLAINTEXT://localhost:9092 </span>
<span class="line"><span class="token comment">#kafka的消息存储文件 </span></span>
<span class="line"><span class="token assign-left variable">log.dir</span><span class="token operator">=</span>/usr/local/data/kafka‐logs </span>
<span class="line"><span class="token comment">#kafka连接zookeeper的地址 </span></span>
<span class="line"><span class="token assign-left variable">zookeeper.connect</span><span class="token operator">=</span>localhost:2181</span>
<span class="line"><span class="token comment"># 启动kafka，运行日志在logs目录的server.log文件里 </span></span>
<span class="line">bin/kafka‐server‐start.sh ‐daemon config/server.properties </span>
<span class="line"><span class="token comment">#后台启动，不会打印日志到控制台 3 或者用 </span></span>
<span class="line">bin/kafka‐server‐start.sh config/server.properties <span class="token operator">&amp;</span> </span>
<span class="line"><span class="token comment"># 我们进入zookeeper目录通过zookeeper客户端查看下zookeeper的目录树 </span></span>
<span class="line">bin/zkCli.sh </span>
<span class="line"><span class="token function">ls</span> / <span class="token comment">#查看zk的根目录kafka相关节点 </span></span>
<span class="line"><span class="token function">ls</span> /brokers/ids <span class="token comment">#查看kafka节点 </span></span>
<span class="line"><span class="token comment"># 停止kafka </span></span>
<span class="line">bin/kafka‐server‐stop.sh</span>
<span class="line"><span class="token comment">#创建名为 test 的 topic,通过手工的方式创建Topic，当producer发布一个消息到某个指定的Topic，这个Topic如果不存在，就自动创建</span></span>
<span class="line"><span class="token comment">#partitions 分区数</span></span>
<span class="line"><span class="token comment">#replication-factor 副本数</span></span>
<span class="line">bin/kafka-topics.sh <span class="token parameter variable">--create</span> <span class="token parameter variable">--zookeeper</span> localhost:2181 --replication-factor <span class="token number">3</span> <span class="token parameter variable">--partitions</span> <span class="token number">3</span> <span class="token parameter variable">--topic</span> topic_test2</span>
<span class="line"><span class="token comment">#查看kafka中目前存在的topic</span></span>
<span class="line">bin/kafka-topics.sh <span class="token parameter variable">--list</span> <span class="token parameter variable">--zookeeper</span> localhost:2181</span>
<span class="line"><span class="token comment">#删除主题</span></span>
<span class="line">bin/kafka-topics.sh <span class="token parameter variable">--delete</span> <span class="token parameter variable">--topic</span> <span class="token builtin class-name">test</span> <span class="token parameter variable">--zookeeper</span> localhost:2181</span>
<span class="line"><span class="token comment">#发送消息,每行都是一条消息</span></span>
<span class="line">bin/kafka-console-producer.sh --broker-list localhost:9092 <span class="token parameter variable">--topic</span> <span class="token builtin class-name">test</span> </span>
<span class="line"><span class="token operator">&gt;</span>this is a msg</span>
<span class="line"><span class="token operator">&gt;</span>this is a another msg </span>
<span class="line"><span class="token comment">#消费消息</span></span>
<span class="line">bin/kafka-console-consumer.sh --bootstrap-server localhost:9092 <span class="token parameter variable">--topic</span> <span class="token builtin class-name">test</span></span>
<span class="line"><span class="token comment">#如果想要消费之前的消息可以通过--from-beginning参数指定，如下命令：</span></span>
<span class="line">bin/kafka-console-consumer.sh --bootstrap-server localhost:9092 </span>
<span class="line"><span class="token parameter variable">--topic</span> <span class="token builtin class-name">test</span> </span>
<span class="line"><span class="token comment">#消费多主题</span></span>
<span class="line">bin/kafka-console-consumer.sh --bootstrap-server localhost:9092 <span class="token parameter variable">--whitelist</span> <span class="token string">&quot;test|test-2&quot;</span></span>
<span class="line"><span class="token comment">#单播消费,一条消息只能被某一个消费者消费的模式，类似queue模式，只需让所有消费者在同一个消费组里即可</span></span>
<span class="line">bin/kafka-console-consumer.sh --bootstrap-server localhost:9092  --consumer-property <span class="token assign-left variable">group.id</span><span class="token operator">=</span>testGroup <span class="token parameter variable">--topic</span> <span class="token builtin class-name">test</span></span>
<span class="line"><span class="token comment">#多播消费 发布订阅模式，指定到不同的消费组中</span></span>
<span class="line">bin/kafka-console-consumer.sh --bootstrap-server localhost:9092 --consumer-property <span class="token assign-left variable">group.id</span><span class="token operator">=</span>testGroup-2 <span class="token parameter variable">--topic</span> <span class="token builtin class-name">test</span></span>
<span class="line"><span class="token comment">#查看消费组名称</span></span>
<span class="line">bin/kafka-consumer-groups.sh --bootstrap-server localhost:9092 <span class="token parameter variable">--list</span> </span>
<span class="line"><span class="token comment">#查看消费组的消费偏移量</span></span>
<span class="line"><span class="token comment">#current-offset：当前消费组的已消费偏移量</span></span>
<span class="line"><span class="token comment">#log-end-offset：主题对应分区消息的结束偏移量(HW)</span></span>
<span class="line"><span class="token comment">#lag：当前消费组未消费的消息数</span></span>
<span class="line">bin/kafka-consumer-groups.sh --bootstrap-server localhost:9092 <span class="token parameter variable">--describe</span> <span class="token parameter variable">--group</span> testGroup-2</span>
<span class="line"><span class="token comment">#增加 partitions 数量</span></span>
<span class="line">bin/kafka-topics.sh <span class="token parameter variable">-alter</span> <span class="token parameter variable">--partitions</span> <span class="token number">3</span> <span class="token parameter variable">--zookeeper</span> localhost:2181 <span class="token parameter variable">--topic</span> test5</span>
<span class="line"><span class="token comment">#查看 topic 状态</span></span>
<span class="line">bin/kafka-topics.sh <span class="token parameter variable">--describe</span> <span class="token parameter variable">--zookeeper</span> <span class="token number">172.23</span>.4.32:2181/kafka/product/kafka821 <span class="token parameter variable">--topic</span> topic_test2</span>
<span class="line"></span>
<span class="line"><span class="token comment">#临时设置日志存储时间</span></span>
<span class="line">bin/kafka-configs.sh  <span class="token parameter variable">--zookeeper</span> <span class="token number">172.23</span>.4.32:2181/kafka/product/kafka821 <span class="token parameter variable">--alter</span> --add-config <span class="token string">&#39;retention.ms=4320000&#39;</span> --entity-name topic_tset2 --entity-type topics</span>
<span class="line"><span class="token comment">#删除设置</span></span>
<span class="line">bin/kafka-configs.sh  <span class="token parameter variable">--zookeeper</span> <span class="token number">172.23</span>.4.32:2181/kafka/product/kafka821 <span class="token parameter variable">--alter</span> --delete-config <span class="token string">&#39;retention.ms&#39;</span> --entity-name topic_tset2 --entity-type topics</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 如果是java客户端，查看消费offset偏移量时，需要带上 --new-consumer 参数</span></span>
<span class="line">bin/kafka-consumer-groups.sh --new-consumer --bootstrap-server <span class="token number">172.23</span>.4.32:9092,172.23.4.33:9092,172.23.4.33:9093 <span class="token parameter variable">--group</span> nike_callback_consumer3 <span class="token parameter variable">--describe</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="组件介绍" tabindex="-1"><a class="header-anchor" href="#组件介绍"><span>组件介绍</span></a></h2><p><img src="/blog/kafka.assets/image-20210531093311879.png" alt="image-20210531093311879"></p><table><thead><tr><th><strong>名称</strong></th><th><strong>解释</strong></th></tr></thead><tbody><tr><td>Broker</td><td>消息中间件处理节点，一个Kafka节点就是一个broker，一个或者多个Broker可以组成一个Kafka集群</td></tr><tr><td>Topic</td><td>Kafka根据topic对消息进行归类，发布到Kafka集群的每条消息都需要指定一个topic</td></tr><tr><td>Producer</td><td>消息生产者，向Broker发送消息的客户端</td></tr><tr><td>Consumer</td><td>消息消费者，从Broker读取消息的客户端</td></tr><tr><td>ConsumerGroup</td><td>每个Consumer属于一个特定的Consumer Group，一条消息可以被多个不同的Consumer Group消费，但是一个Consumer Group中只能有一个Consumer能够消费该消息</td></tr><tr><td>Partition</td><td>物理上的概念，一个topic可以分为多个partition，每个partition内部消息是有序的</td></tr></tbody></table><h3 id="server-properties-主要配置" tabindex="-1"><a class="header-anchor" href="#server-properties-主要配置"><span>server.properties 主要配置</span></a></h3><div class="language-http line-numbers-mode" data-highlighter="prismjs" data-ext="http" data-title="http"><pre><code><span class="line">#配置文档地址</span>
<span class="line"><span class="token header"><span class="token header-name keyword">http</span><span class="token punctuation">:</span><span class="token header-value">//kafka.apache.org/documentation/#brokerconfigs</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><table><thead><tr><th><strong>Property</strong></th><th><strong>Default</strong></th><th><strong>Description</strong></th></tr></thead><tbody><tr><td>broker.id</td><td>0</td><td>每个broker都可以用一个唯一的非负整数id进行标识；这个id可以作为broker的<code>名字</code>，你可以选择任意你喜欢的数字作为id，只要id是唯一的即可。</td></tr><tr><td>log.dirs</td><td>/tmp/kafka-logs</td><td>kafka存放数据的路径。这个路径并不是唯一的，可以是多个，路径之间只需要使用逗号分隔即可；每当创建新partition时，都会选择在包含最少partitions的路径下进行。</td></tr><tr><td>listeners</td><td>PLAINTEXT://localhost:9092</td><td>server接受客户端连接的端口，ip配置kafka本机ip即可</td></tr><tr><td>zookeeper.connect</td><td>localhost:2181</td><td>zooKeeper连接字符串的格式为：hostname:port，此处hostname和port分别是ZooKeeper集群中某个节点的host和port；zookeeper如果是集群，连接方式为 hostname1:port1, hostname2:port2, hostname3:port3</td></tr><tr><td>log.retention.hours</td><td>168</td><td>每个日志文件删除之前保存的时间。默认数据保存时间对所有topic都一样。</td></tr><tr><td>num.partitions</td><td>1</td><td>创建topic的默认分区数</td></tr><tr><td>default.replication.factor</td><td>1</td><td>自动创建topic的默认副本数量，建议设置为大于等于2</td></tr><tr><td>min.insync.replicas</td><td>1</td><td>当producer设置acks为-1时，min.insync.replicas指定replicas的最小数目（必须确认每一个repica的写数据都是成功的），如果这个数目没有达到，producer发送消息会产生异常</td></tr></tbody></table><h2 id="使用" tabindex="-1"><a class="header-anchor" href="#使用"><span>使用：</span></a></h2><h3 id="controller" tabindex="-1"><a class="header-anchor" href="#controller"><span>Controller</span></a></h3><blockquote><p>在Kafka早期版本，对于分区和副本的状态的管理依赖于zookeeper的Watcher和队列：每一个broker都会在zookeeper注册Watcher，所以zookeeper就会出现大量的Watcher, 假设某个broker宕机，且此broker上的partition很多比较多，会造成多个Watcher触发，造成集群内大规模调整；每一个replica都要去再次zookeeper上注册监视器，当集群规模很大的时候，zookeeper负担很重。这种设计很容易出现脑裂和羊群效应以及zookeeper集群过载</p></blockquote><p>在<code>kafka</code>集群中，会有一个或多个<code>broker</code>，其中一个<code>broker</code>被选为<code>控制器(Controller)</code>，主要职责：</p><ul><li><code>partition leader</code> 选举</li><li>主题管理（创建、删除、增加分区） <ul><li>这里的主题管理，就是指控制器帮助我们完成对 Kafka，主题的创建、删除以及分区增加的操作；</li></ul></li><li>分区重分配 <ul><li>当某个<code>Topic</code>增加分区时，负责新分区 被其他<code>broker</code>感知到</li></ul></li><li>集群成员管理 <ul><li>自动检测新增 Broker、Broker 主动关闭及被动宕机，监听<code>/brokers/ids</code>子节点的数据变更</li></ul></li><li>数据服务 <ul><li>向其他 Broker 提供数据服务</li><li>所有主题信息。包括具体的分区信息，比如领导者副本是谁，ISR 集合中有哪些副本等。</li><li>所有 Broker 信息。包括当前都有哪些运行中的 Broker，哪些正在关闭中的 Broker 等。</li><li>所有涉及运维任务的分区。包括当前正在进行<code>leader</code>选举以及分区重分配的分区列表。</li><li>值得注意的是，这些数据其实在 ZooKeeper 中也保存了一份。每当控制器初始化时，它都会从 ZooKeeper 上读取对应的元数据并填充到自己的缓存中。有了这些数据，控制器就能对外提供数据服务了。这里的对外主要是指对其他 Broker 而言，控制器通过向这些 Broker 发送请求的方式将这些数据同步到其他 Broker 上</li></ul></li></ul><h4 id="controller选举机制" tabindex="-1"><a class="header-anchor" href="#controller选举机制"><span>Controller选举机制</span></a></h4><ul><li><p>每个<code>broker</code>会尝试在zk创建<code>/controller</code> <code>临时</code>节点，谁创建成功，就会成为集群的总控制器<code>controller</code></p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token punctuation">{</span><span class="token string">&quot;version&quot;</span>:1,<span class="token string">&quot;brokerid&quot;</span>:0,<span class="token string">&quot;timestamp&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;1622977268033&quot;</span><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div></li><li><p>集群中的其他<code>broker</code>都会一直监听<code>/controller</code>，如果<code>controller</code>所在的broker宕机，临时节点消失，则会竞争再次创建<code>/controller</code>临时节点，选举出新的<code>controller</code></p></li><li><p>每个<code>broker</code>内存中还会记录有<code>activeControllerId</code>,如果某个broker之前是<code>ctonrller</code>,由于网络等原因，导致集群中的<code>controller</code>重新选举，网络恢复后，获取到<code>/controler</code>节点中记录的和自身<code>brokerId</code>不同，则会进行<code>退位</code>操作,比如关闭相应资源，关闭一些zk监听节点等</p></li><li><p>可以通过手动删除zk下<code>/controller</code>节点，来触发<code>Controller</code>的选举</p></li></ul><h4 id="controller唯一性" tabindex="-1"><a class="header-anchor" href="#controller唯一性"><span>Controller唯一性</span></a></h4><ul><li><code>controller_epoch</code>:用于记录<code>controller</code>的变更次数，保存在zk<code>/controller_epoch</code>中，初始值为1，控制器发生变更时，此值增加1，也称作<code>控制器的纪元</code></li><li><code>broker</code>会存储最新<code>/controller_epoch</code>的值，控制器的每次交互，都会携带上<code>controller_epoch</code>这个字段，收到<code>controller</code>的命令之后，会拿到<code>controller_epoch</code>进行比较，如果小于内存中的<code>controller_epoch</code>，则忽略此命令</li></ul><h3 id="topic和partition" tabindex="-1"><a class="header-anchor" href="#topic和partition"><span>Topic和partition</span></a></h3><h4 id="概念" tabindex="-1"><a class="header-anchor" href="#概念"><span>概念：</span></a></h4><p>可以理解Topic是一个类别的名称，同类消息发送到同一个Topic下面。对于每一个Topic，下面可以有多个分区(Partition)日志文件:</p><p>Partition是一个有序的message序列，这些message按顺序添加到一个叫做commit log的文件中。每个partition中的消息都有一个唯一的编号，称之为offset，用来唯一标示某个分区中的message。 每个partition，都对应一个commit log文件。一个partition中的message的offset都是唯一的，但是不同的partition中的message的offset可能是相同的。</p><p>每个partition，存在1个<code>leader</code> , 0个或多个<code>followers</code>,<strong>leader处理所有的针对这个partition的读写请求，followers被动复制leader的结果，不提供读写，如果某个leader宕机，其中的一个follower将会自动变成新的leader</strong>。可以看到每个<code>partition</code>的<code>leader</code>及<code>follower</code>，均匀的分布在不同的<code>broker</code>,且一个<code>broker</code>不可能出现某个<code>partition</code>的多个副本</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token comment">#查看 topic 状态</span></span>
<span class="line">bin/kafka-topics.sh <span class="token parameter variable">--describe</span> <span class="token parameter variable">--zookeeper</span> localhost:2181 <span class="token parameter variable">--topic</span> topic_test2</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="/blog/kafka.assets/image-20210523183408179.png" alt="image-20210523183408179"></p><ul><li>leader节点负责给定partition的所有读写请求</li><li>replicas 表示某个partition在哪几个broker上存在备份。不管这个几点是不是<code>leader</code>，甚至这个节点挂了，也会列出。</li><li>isr 是replicas的一个子集，它只列出当前还存活着的，并且<strong>已同步备份</strong>了该partition的节点。 <ul><li>节点必须能够维护与ZooKeeper的会话(通过ZooKeeper的心跳机制)</li><li>副本能复制leader上的所有写操作，并且不能落后太多 <ul><li>与leader副本同步滞后的副本，是由 <code>replica.lag.time.max.ms</code> 配置决定的，超过这个时间都没有跟leader同步过的一次的副本会被移出ISR列表</li></ul></li></ul></li></ul><blockquote><p>当kill broker.id =0 的节点之后，再查看 topic的信息：</p><p><img src="/blog/kafka.assets/image-20210523184704038.png" alt="image-20210523184704038"></p></blockquote><h4 id="leader选举机制" tabindex="-1"><a class="header-anchor" href="#leader选举机制"><span>Leader选举机制</span></a></h4><ul><li><code>controller</code>是什么?</li><li><code>controller</code>感知到分区<code>leader</code>所在的<code>broker</code>挂了(controller 通过监听zk节点)</li><li><code>unclean.leader.election.enable=false</code>，<code>controller</code>会根据<code>AR</code>集合的顺序，并且在<code>ISR</code>列表中存活的作为<code>leader</code>「优先副本」 <ul><li>优先副本：replicas 中的第一个</li></ul></li><li>如果参数<code>unclean.leader.election.enable=true</code>，则可以在<code>ISR</code>以外的列表中选择<code>leader</code>,这种可以提高可用性，但是选择的<code>leader</code>可能数据缺失比较多</li></ul><h4 id="分区自动平衡" tabindex="-1"><a class="header-anchor" href="#分区自动平衡"><span>分区自动平衡</span></a></h4><blockquote><p><code>broker</code> 自平衡</p></blockquote><p><strong>执行下面步骤</strong></p><ul><li>kill <code>broker2</code>，此时<code>partition0</code>、<code>partition1</code> 的 leader都在broker0</li></ul><p><img src="/blog/kafka.assets/image-20210609214557490.png" alt="image-20210609214557490"></p><ul><li>启动<code>broker2</code>，刚启动时，<code>partition0</code>、<code>partition1</code> 的 leader都在broker0</li></ul><p><img src="/blog/kafka.assets/image-20210609214455036.png" alt="image-20210609214455036"></p><ul><li>注意：此时 broker0 的平衡率= <code>非优先副本的leader个数(partition0)</code> /<code>总分区数(3)</code> =33.33%,大于默认的10%</li><li>五分钟后：partition0, leader 重新选举为 broker2</li></ul><p><img src="/blog/kafka.assets/image-20210609214824009.png" alt="image-20210609214824009"></p><blockquote><p>通过上面现象可知：分区自平衡，是自动帮助broker均衡压力的一种机制</p><p>注意：生产环境建议关闭自动平衡，因为自平衡过程中，势必造成业务阻塞，频繁超时情况，所以建议手动平衡</p></blockquote><div class="language-properties line-numbers-mode" data-highlighter="prismjs" data-ext="properties" data-title="properties"><pre><code><span class="line"><span class="token comment">#是否开启自动平衡</span></span>
<span class="line"><span class="token key attr-name">auto.leader.rebalance.enabl</span><span class="token punctuation">:</span><span class="token value attr-value">true</span></span>
<span class="line"><span class="token comment">#broker中的不平衡率 = 非优先副本的leader个数 / 分区总数</span></span>
<span class="line"><span class="token comment">#优先副本：replicas 中的第一个</span></span>
<span class="line"><span class="token comment">#不平衡率 &gt; 此配置(%)，则需要出发自动平衡策略，将优先副本设置为leader</span></span>
<span class="line"><span class="token key attr-name">leader.imbalance.per.broker.percentage</span><span class="token punctuation">=</span><span class="token value attr-value">10</span></span>
<span class="line"><span class="token comment">#执行周期 300s,五分钟</span></span>
<span class="line"><span class="token key attr-name">leader.imbalance.check.interval.seconds</span><span class="token punctuation">=</span><span class="token value attr-value">300</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">#手动执行</span></span>
<span class="line"><span class="token key attr-name">bin/kafka-preferred-replica-election.sh</span> <span class="token value attr-value">--zookeeper localhost:2181</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="如何选择合适的分区数" tabindex="-1"><a class="header-anchor" href="#如何选择合适的分区数"><span>如何选择合适的分区数？</span></a></h4><h5 id="性能测试工具" tabindex="-1"><a class="header-anchor" href="#性能测试工具"><span>性能测试工具</span></a></h5><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token comment"># num-records 数据条数</span></span>
<span class="line"><span class="token comment"># record-size 每条数据大小</span></span>
<span class="line"><span class="token comment"># throughput 小于0，表示不限速，大于0，每秒限速(kb/s)</span></span>
<span class="line"><span class="token comment"># acks 0直接返回，1 leader持久化后返回，-1 或 all 所有副本持久化后返回</span></span>
<span class="line"><span class="token comment"># print-metrics 额外打印一些指标信息</span></span>
<span class="line">bin/kafka-producer-perf-test.sh <span class="token parameter variable">--topic</span> topic_test --num-records <span class="token number">1000</span> --record-size <span class="token number">1024</span> <span class="token parameter variable">--throughput</span> <span class="token parameter variable">-1</span> --producer-props <span class="token assign-left variable">bootstrap.servers</span><span class="token operator">=</span>localhost:9092 <span class="token assign-left variable">acks</span><span class="token operator">=</span><span class="token number">1</span> --print-metrics</span>
<span class="line"></span>
<span class="line"><span class="token comment"># records/sec 每秒发送的数据条数</span></span>
<span class="line"><span class="token comment"># MB/sec 每秒发送大小</span></span>
<span class="line"><span class="token comment"># avg latency 每条消息处理平均时长</span></span>
<span class="line"><span class="token comment"># max latency 每条消息处理最大时长</span></span>
<span class="line"><span class="token comment"># 10 ms 50th, 15 ms 95th, 15 ms 99th, 134 ms 99.9th，表示 50%、95% 等消息处理时长</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><img src="/blog/kafka.assets/image-20210608094154665.png" alt="image-20210608094154665" style="zoom:150%;"><p>当设置 <code>throughput 100 时</code></p><img src="/blog/kafka.assets/image-20210608094230053.png" alt="image-20210608094230053" style="zoom:150%;"><h5 id="分区数越多吞吐量越高吗" tabindex="-1"><a class="header-anchor" href="#分区数越多吞吐量越高吗"><span>分区数越多吞吐量越高吗?</span></a></h5><ul><li><p>首先分别创建分区数为 20、50、100、200、500、1000 topic，对应 主题名称分别为 topic-1、topic 20、topic-50、topic-100、topic-200、topic-500、topic-1000 ，所有主题的副本因子都设置为 0</p></li><li><p>每个topic都发送 1000000条，size=1024的数据，结果如下：</p><img src="/blog/kafka.assets/image-20210608095811782.png" alt="image-20210608095811782"></li></ul><blockquote><p>注意：此结果比较片面，跟硬件环境有一定关系，只是能说明一种现象，并非随着分区数增加，吞吐量一直增加</p></blockquote><h5 id="分区数如何设置" tabindex="-1"><a class="header-anchor" href="#分区数如何设置"><span>分区数如何设置</span></a></h5><blockquote><p>最好的答案是：视具体情况而定</p><p>如上述实验，合适的分区数增加，能够在一定程度上提高吞吐量，但是超过一定阈值后，不升反降，所以如果对吞吐量有一定要求，最好的方案是：投入生产环境之前，模拟线上硬件环境、数据量，做一个完整的吞吐量测试，以找到合适的分区数阈值，同时尽量设置分区数为集群内broker节点的倍数；如 3个broker，可以设定分区数3、6、9等，倍数的选定，可以参考预估的吞吐量。但是broker数量很多的几十上百，则这种方式也不适用，进一步考虑基础架构的参考因素</p><p>分区数上限：受到系统文件描述符限制</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token comment">#软限制</span></span>
<span class="line"><span class="token builtin class-name">ulimit</span> <span class="token parameter variable">-Sn</span></span>
<span class="line"><span class="token comment">#硬限制</span></span>
<span class="line"><span class="token builtin class-name">ulimit</span> <span class="token parameter variable">-Hn</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></blockquote><h4 id="为什么要对topic下数据进行分区存储" tabindex="-1"><a class="header-anchor" href="#为什么要对topic下数据进行分区存储"><span><strong>为什么要对Topic下数据进行分区存储？</strong></span></a></h4><ul><li>commit log文件会受到所在机器的文件系统大小的限制，分区之后可以将不同的分区放在不同的机器上，相当于对数据做了分布式存储，理论上一个topic可以处理任意数量的数据。</li><li>提高可用性</li><li>提高并行度</li></ul><h3 id="producer" tabindex="-1"><a class="header-anchor" href="#producer"><span>producer</span></a></h3><h4 id="拦截器" tabindex="-1"><a class="header-anchor" href="#拦截器"><span>拦截器：</span></a></h4><blockquote><ul><li>onSend：分区路由选择之前，调用此方法</li><li>onAcknowledgement：callback方法之前</li><li>close：producer 客户端调用close之后</li><li>configure：可以拿到客户端的所有配置</li></ul><p>可以使用此方式，做一些值统一处理，或者日志信息打印等</p></blockquote><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyProducerInterceptor</span> <span class="token keyword">implements</span> <span class="token class-name">ProducerInterceptor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">long</span> successCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">long</span> failCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 增加 value 前缀</span></span>
<span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">onSend</span><span class="token punctuation">(</span><span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> record<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">String</span> newValue <span class="token operator">=</span> <span class="token string">&quot;new-- &quot;</span> <span class="token operator">+</span> record<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>record<span class="token punctuation">.</span><span class="token function">topic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> record<span class="token punctuation">.</span><span class="token function">partition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> record<span class="token punctuation">.</span><span class="token function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> newValue<span class="token punctuation">,</span> record<span class="token punctuation">.</span><span class="token function">headers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onAcknowledgement</span><span class="token punctuation">(</span><span class="token class-name">RecordMetadata</span> metadata<span class="token punctuation">,</span> <span class="token class-name">Exception</span> exception<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">isNull</span><span class="token punctuation">(</span>exception<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;发送成功&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;发送失败&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token comment">// TODO: 2021/6/9  </span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">&gt;</span></span> configs<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 配置, 多个拦截器 逗号隔开，按顺序执行</span></span>
<span class="line">props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span><span class="token constant">INTERCEPTOR_CLASSES_CONFIG</span><span class="token punctuation">,</span> <span class="token class-name">MyProducerInterceptor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="消息路由" tabindex="-1"><a class="header-anchor" href="#消息路由"><span>消息路由：</span></a></h4><p>选择<code>partition</code>机制为：</p><ul><li>如果指定<code>partition</code>，直接使用</li><li>未指定<code>partition</code>，但指定了<code>key</code>,对<code>key 进行 hash（MurmurHash2）</code>,与总的分区数取模<code>%</code>，计算出<code>partition</code></li><li><code>partition</code> 和 <code>key</code>都未指定，轮询方式发送至可用分区</li></ul><blockquote><p>注意：如果key不为null，会选择所有分区中的某一个，如果key为null，会选择可用分区的某一个</p><p>参考：<code>org.apache.kafka.clients.producer.internals.DefaultPartitioner</code></p></blockquote><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token comment">// org.apache.kafka.clients.producer.internals.DefaultPartitioner#partition</span></span>
<span class="line">        <span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">partition</span><span class="token punctuation">(</span><span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> record<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> serializedKey<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> serializedValue<span class="token punctuation">,</span> <span class="token class-name">Cluster</span> cluster<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">Integer</span> partition <span class="token operator">=</span> record<span class="token punctuation">.</span><span class="token function">partition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> partition <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span></span>
<span class="line">                partition <span class="token operator">:</span></span>
<span class="line">                partitioner<span class="token punctuation">.</span><span class="token function">partition</span><span class="token punctuation">(</span></span>
<span class="line">                        record<span class="token punctuation">.</span><span class="token function">topic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> record<span class="token punctuation">.</span><span class="token function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> serializedKey<span class="token punctuation">,</span> record<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> serializedValue<span class="token punctuation">,</span> cluster<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span class="token comment">// org.apache.kafka.clients.producer.internals.DefaultPartitioner#partition</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">partition</span><span class="token punctuation">(</span><span class="token class-name">String</span> topic<span class="token punctuation">,</span> <span class="token class-name">Object</span> key<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> keyBytes<span class="token punctuation">,</span> <span class="token class-name">Object</span> value<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> valueBytes<span class="token punctuation">,</span> <span class="token class-name">Cluster</span> cluster<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>keyBytes <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> stickyPartitionCache<span class="token punctuation">.</span><span class="token function">partition</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> cluster<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span> </span>
<span class="line">        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PartitionInfo</span><span class="token punctuation">&gt;</span></span> partitions <span class="token operator">=</span> cluster<span class="token punctuation">.</span><span class="token function">partitionsForTopic</span><span class="token punctuation">(</span>topic<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">int</span> numPartitions <span class="token operator">=</span> partitions<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">// hash the keyBytes to choose a partition</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token class-name">Utils</span><span class="token punctuation">.</span><span class="token function">toPositive</span><span class="token punctuation">(</span><span class="token class-name">Utils</span><span class="token punctuation">.</span><span class="token function">murmur2</span><span class="token punctuation">(</span>keyBytes<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">%</span> numPartitions<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span class="token comment">// org.apache.kafka.clients.producer.internals.StickyPartitionCache#nextPartition</span></span>
<span class="line">     <span class="token keyword">while</span> <span class="token punctuation">(</span>newPart <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> newPart<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>oldPart<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">         <span class="token class-name">Integer</span> random <span class="token operator">=</span> <span class="token class-name">Utils</span><span class="token punctuation">.</span><span class="token function">toPositive</span><span class="token punctuation">(</span><span class="token class-name">ThreadLocalRandom</span><span class="token punctuation">.</span><span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">         newPart <span class="token operator">=</span> availablePartitions<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>random <span class="token operator">%</span> availablePartitions<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">partition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">     <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="java客户端使用" tabindex="-1"><a class="header-anchor" href="#java客户端使用"><span>JAVA客户端使用：</span></a></h4><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line">        <span class="token class-name">Properties</span> props <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span><span class="token constant">BOOTSTRAP_SERVERS_CONFIG</span><span class="token punctuation">,</span> <span class="token string">&quot;localhost:9092,localhost:9093,localhost:9094&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">         <span class="token comment">/*</span>
<span class="line">         发出消息持久化机制参数</span>
<span class="line">        （1）acks=0： 表示producer不需要等待任何broker确认收到消息的回复，就可以继续发送下一条消息。性能最高，但是最容易丢消息。</span>
<span class="line">        （2）acks=1： 至少要等待leader已经成功将数据写入本地log，但是不需要等待所有follower是否成功写入。就可以继续发送下一</span>
<span class="line">             条消息。这种情况下，如果follower没有成功备份数据，而此时leader又挂掉，则消息会丢失。</span>
<span class="line">        （3）acks=-1或all： 需要等待 min.insync.replicas(默认为1，推荐配置大于等于2) 这个参数配置的副本个数都成功写入日志，这种策略会保证</span>
<span class="line">            只要有一个备份存活就不会丢失数据。这是最强的数据保证。一般除非是金融级别，或跟钱打交道的场景才会使用这种配置。</span>
<span class="line">         */</span></span>
<span class="line">        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span><span class="token constant">ACKS_CONFIG</span><span class="token punctuation">,</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">// 发送失败会重试，默认重试间隔100ms，重试能保证消息发送的可靠性，但是也可能造成消息重复发送，比如网络抖动，所以需要在</span></span>
<span class="line">        <span class="token comment">// 接收者那边做好消息接收的幂等性处理</span></span>
<span class="line">        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span><span class="token constant">RETRIES_CONFIG</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//重试间隔设置</span></span>
<span class="line">        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span><span class="token constant">RETRY_BACKOFF_MS_CONFIG</span><span class="token punctuation">,</span> <span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//设置发送消息的本地缓冲区，如果设置了该缓冲区，消息会先发送到本地缓冲区，可以提高消息发送性能，默认值是33554432，即32MB</span></span>
<span class="line">        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span><span class="token constant">BUFFER_MEMORY_CONFIG</span><span class="token punctuation">,</span> <span class="token number">33554432</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">// kafka本地线程会从缓冲区取数据，批量发送到broker，</span></span>
<span class="line">        <span class="token comment">// 设置批量发送消息的大小，默认值是16384，即16kb，就是说一个batch满了16kb就发送出去</span></span>
<span class="line">        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span><span class="token constant">BATCH_SIZE_CONFIG</span><span class="token punctuation">,</span> <span class="token number">16384</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">// 默认值是0，意思就是消息必须立即被发送，但这样会影响性能</span></span>
<span class="line">        <span class="token comment">// 一般设置10毫秒左右，就是说这个消息发送完后会进入本地的一个batch，如果10毫秒内，这个batch满了16kb就会随batch一起被发送出去</span></span>
<span class="line">        <span class="token comment">// 如果10毫秒内，batch没满，那么也必须把消息发送出去，不能让消息的发送延迟时间太长</span></span>
<span class="line">        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span><span class="token constant">LINGER_MS_CONFIG</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//把发送的key从字符串序列化为字节数组</span></span>
<span class="line">        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span><span class="token constant">KEY_SERIALIZER_CLASS_CONFIG</span><span class="token punctuation">,</span> <span class="token class-name">StringSerializer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//把发送消息value从字符串序列化为字节数组</span></span>
<span class="line">        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span><span class="token constant">VALUE_SERIALIZER_CLASS_CONFIG</span><span class="token punctuation">,</span> <span class="token class-name">StringSerializer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span><span class="token constant">INTERCEPTOR_CLASSES_CONFIG</span><span class="token punctuation">,</span> <span class="token class-name">MyProducerInterceptor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">Producer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> producer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KafkaProducer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">int</span> msgNum <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">final</span> <span class="token class-name">CountDownLatch</span> countDownLatch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CountDownLatch</span><span class="token punctuation">(</span>msgNum<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> msgNum<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">//指定发送分区</span></span>
<span class="line">            <span class="token comment">// ProducerRecord&lt;String, String&gt; producerRecord = new ProducerRecord&lt;String, String&gt;(TOPIC_NAME</span></span>
<span class="line">            <span class="token comment">//         , 0, order.getOrderId().toString(), JSON.toJSONString(order));</span></span>
<span class="line">            <span class="token comment">//未指定发送分区，具体发送的分区计算公式：hash(key)%partitionNum</span></span>
<span class="line">            <span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> producerRecord <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token constant">TOPIC_NAME</span><span class="token punctuation">,</span> <span class="token string">&quot;hhh:&quot;</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">            <span class="token comment">//等待消息发送成功的同步阻塞方法</span></span>
<span class="line">            <span class="token comment">/*RecordMetadata metadata = producer.send(producerRecord).get();</span>
<span class="line">            System.out.println(&quot;同步方式发送消息结果：&quot; + &quot;topic-&quot; + metadata.topic() + &quot;|partition-&quot;</span>
<span class="line">                    + metadata.partition() + &quot;|offset-&quot; + metadata.offset());*/</span></span>
<span class="line"></span>
<span class="line">            <span class="token comment">//异步回调方式发送消息</span></span>
<span class="line">            producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>producerRecord<span class="token punctuation">,</span> <span class="token punctuation">(</span>metadata<span class="token punctuation">,</span> exception<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">if</span> <span class="token punctuation">(</span>exception <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                    <span class="token class-name">System</span><span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;发送消息失败：&quot;</span> <span class="token operator">+</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>exception<span class="token punctuation">.</span><span class="token function">getStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">                <span class="token keyword">if</span> <span class="token punctuation">(</span>metadata <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;异步方式发送消息结果：&quot;</span> <span class="token operator">+</span> <span class="token string">&quot;topic-&quot;</span> <span class="token operator">+</span> metadata<span class="token punctuation">.</span><span class="token function">topic</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;|partition-&quot;</span></span>
<span class="line">                            <span class="token operator">+</span> metadata<span class="token punctuation">.</span><span class="token function">partition</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;|offset-&quot;</span> <span class="token operator">+</span> metadata<span class="token punctuation">.</span><span class="token function">offset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">                countDownLatch<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        countDownLatch<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        producer<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="原理图" tabindex="-1"><a class="header-anchor" href="#原理图"><span>原理图：</span></a></h4><p><img src="/blog/kafka.assets/%E4%BC%81%E4%B8%9A%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_612a3d0d-2731-42a6-8c3d-1219647a3ab3.png" alt="企业微信截图_612a3d0d-2731-42a6-8c3d-1219647a3ab3"></p><ul><li><code>org.apache.kafka.clients.producer.internals.RecordAccumulator</code><ul><li>消息累加器，本地消息的缓存</li><li><code>ConcurrentMap&lt;TopicPartition, Deque&lt;ProducerBatch&gt;&gt; batches</code><ul><li>key：分区</li><li>value：双端队列，保存消息<code>ProducerBatch</code></li></ul></li><li>ProducerBatch：一批<code>ProducerRecord</code> ,默认 16kb</li></ul></li><li><code>org.apache.kafka.clients.producer.internals.Sender</code><ul><li><code>implements Runnable</code>异步线程，从<code>RecordAccumulator</code>中获取消息</li><li>封装成<code>clientRequest</code><ul><li>封装成<code>inFlightRequest</code>对象，缓存到到：<code>org.apache.kafka.clients.InFlightRequests#requests</code><ul><li>Map&lt;BrokerId，InFlightRequest&gt;</li></ul></li><li><code>selector.send(send)</code></li></ul></li></ul></li><li><code>org.apache.kafka.clients.InFlightRequests</code><ul><li>请求发出时缓存，收到响应 或者 检测到超时后，会进行清理</li><li><strong>作用：</strong><ul><li>控制每个broker节点，正在运行请求的个数，默认5,超过此个数，则循环阻塞，配置参数：<code>max.in.flight.requests.per.connection</code></li><li>同步集群元数据流程和正常发送消息类似，也是封装 <code>MetadataRequest</code>，并且缓存在此，<code>InFlightRequests</code>缓存中，可以找到压力最小的 <code>broker</code>节点，使用此节点来进行元数据的同步</li></ul></li></ul></li></ul><h4 id="元数据同步" tabindex="-1"><a class="header-anchor" href="#元数据同步"><span>元数据同步</span></a></h4><blockquote><p>客户端超过<code>metadata.max.age.ms</code>配置时间元数据没有更新，则会触发元数据同步</p><p>元数据是指 Kafka 集群的元数据，这些元数据具体记录了集群中有哪些主题，这些主题有哪些分区，每个分区的 leader副本分配在哪个节点上， follower 副本分配在哪些节点上，哪些副本在 AR ISR 等集合中，集群中有哪些节点，控制器节点又是哪一个等信息。</p></blockquote><h4 id="写入流程" tabindex="-1"><a class="header-anchor" href="#写入流程"><span>写入流程：</span></a></h4><ul><li><code>producer</code>从<code>zk</code>中找到<code>partition</code>的<code>leader</code>节点 <img src="/blog/kafka.assets/image-20210601090513559.png" alt="image-20210601090513559"></li><li>将消息发送至<code>leader</code>节点</li><li><code>leader</code>将消息写入本地log</li><li><code>follower</code>从 <code>leader pull</code>消息，写入本地后，向<code>leader</code>发送<code>Ack</code></li><li><code>leader</code>收到所有 <code>ISR</code> 中节点的<code>Ack</code>后，增加<code>HW(hign watemark)</code></li></ul><h4 id="hw和leo" tabindex="-1"><a class="header-anchor" href="#hw和leo"><span><code>HW</code>和<code>LEO</code></span></a></h4><p><code>HW</code>高水位，HighWatemark的缩写，取一个<code>partition</code>对应的<code>ISR中最小的LEO(log-end-offset)作为HW</code>,<code>consumer</code>最多只能消费到<code>HW</code>所在的位置</p><p>过程如下：</p><p><img src="/blog/kafka.assets/image-20210602090739069.png" alt="image-20210602090739069"></p><p>为什么这么设计？</p><ul><li>保证各个副本<code>可消费</code>数据一致性</li></ul><h4 id="问题" tabindex="-1"><a class="header-anchor" href="#问题"><span>问题：</span></a></h4><p><strong>producer 发送套路</strong></p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">ApiKeys</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// producer 发送数据</span></span>
<span class="line">    <span class="token function">PRODUCE</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">&quot;Produce&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token comment">// 元数据请求</span></span>
<span class="line">    <span class="token function">METADATA</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">&quot;Metadata&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token comment">// consumer offset 提交</span></span>
<span class="line">    <span class="token function">OFFSET_COMMIT</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">&quot;OffsetCommit&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token comment">// consumer offset 获取</span></span>
<span class="line">    <span class="token function">OFFSET_FETCH</span><span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">,</span> <span class="token string">&quot;OffsetFetch&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token comment">// consumer 加入消费组</span></span>
<span class="line">    <span class="token function">JOIN_GROUP</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">,</span> <span class="token string">&quot;JoinGroup&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token comment">// consumer 心跳</span></span>
<span class="line">    <span class="token function">HEARTBEAT</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">,</span> <span class="token string">&quot;Heartbeat&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token comment">// 消费组离开 group</span></span>
<span class="line">    <span class="token function">LEAVE_GROUP</span><span class="token punctuation">(</span><span class="token number">13</span><span class="token punctuation">,</span> <span class="token string">&quot;LeaveGroup&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token comment">// 消费组 同步消费组内的分区方案</span></span>
<span class="line">    <span class="token function">SYNC_GROUP</span><span class="token punctuation">(</span><span class="token number">14</span><span class="token punctuation">,</span> <span class="token string">&quot;SyncGroup&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token comment">//...... more</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>producer Ack1，hw没有更新，能消费到么？</strong></p><ul><li>不能</li></ul><p><strong>metadata 更新时机：</strong></p><blockquote><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token class-name">MetadataResponseData</span><span class="token punctuation">(</span>throttleTimeMs<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> </span>
<span class="line">brokers<span class="token operator">=</span><span class="token punctuation">[</span></span>
<span class="line"> <span class="token class-name">MetadataResponseBroker</span><span class="token punctuation">(</span>nodeId<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> host<span class="token operator">=</span>&#39;<span class="token number">172.30</span><span class="token number">.105</span><span class="token number">.131</span>&#39;<span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">9092</span><span class="token punctuation">,</span> rack<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">,</span> </span>
<span class="line"> <span class="token class-name">MetadataResponseBroker</span><span class="token punctuation">(</span>nodeId<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> host<span class="token operator">=</span>&#39;<span class="token number">172.30</span><span class="token number">.105</span><span class="token number">.131</span>&#39;<span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">9094</span><span class="token punctuation">,</span> rack<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">,</span> </span>
<span class="line"> <span class="token class-name">MetadataResponseBroker</span><span class="token punctuation">(</span>nodeId<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> host<span class="token operator">=</span>&#39;<span class="token number">172.30</span><span class="token number">.105</span><span class="token number">.131</span>&#39;<span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">9093</span><span class="token punctuation">,</span> rack<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">]</span><span class="token punctuation">,</span> </span>
<span class="line">clusterId<span class="token operator">=</span>&#39;<span class="token class-name">M8qSCCTbR1OV0FTd_rm_PA</span>&#39;<span class="token punctuation">,</span> controllerId<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> </span>
<span class="line">topics<span class="token operator">=</span><span class="token punctuation">[</span></span>
<span class="line"> <span class="token class-name">MetadataResponseTopic</span><span class="token punctuation">(</span>errorCode<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token char">&#39;test5&#39;</span><span class="token punctuation">,</span> isInternal<span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">,</span> </span>
<span class="line">                       partitions<span class="token operator">=</span><span class="token punctuation">[</span></span>
<span class="line">                         <span class="token class-name">MetadataResponsePartition</span><span class="token punctuation">(</span>errorCode<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> partitionIndex<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> leaderId<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> leaderEpoch<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> replicaNodes<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> isrNodes<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> offlineReplicas<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">                         <span class="token class-name">MetadataResponsePartition</span><span class="token punctuation">(</span>errorCode<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> partitionIndex<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> leaderId<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> leaderEpoch<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> replicaNodes<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> isrNodes<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> offlineReplicas<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> </span>
<span class="line">                         <span class="token class-name">MetadataResponsePartition</span><span class="token punctuation">(</span>errorCode<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> partitionIndex<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> leaderId<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> leaderEpoch<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> replicaNodes<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> isrNodes<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> offlineReplicas<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> </span>
<span class="line">topicAuthorizedOperations<span class="token operator">=</span><span class="token operator">-</span><span class="token number">2147483648</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">clusterAuthorizedOperations<span class="token operator">=</span><span class="token operator">-</span><span class="token number">2147483648</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></blockquote><ul><li><p><code>send</code> 方法时，强制等待更新一次</p><ul><li><p>设置<code>needUpdate</code> 为<code>true</code></p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">awaitUpdate</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">int</span> lastVersion<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">long</span> maxWaitMs<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>maxWaitMs <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;Max time to wait for metadata updates should not be &lt; 0 milli seconds&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token keyword">long</span> begin <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">// metadata.fetch.timeout.ms 元数据更新等待最大时间</span></span>
<span class="line">  <span class="token keyword">long</span> remainingWaitMs <span class="token operator">=</span> maxWaitMs<span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">// 没有更新，则一直 wait</span></span>
<span class="line">  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>version <span class="token operator">&lt;=</span> lastVersion<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>remainingWaitMs <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span></span>
<span class="line">      <span class="token function">wait</span><span class="token punctuation">(</span>remainingWaitMs<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">long</span> elapsed <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> begin<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>elapsed <span class="token operator">&gt;=</span> maxWaitMs<span class="token punctuation">)</span></span>
<span class="line">      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TimeoutException</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to update metadata after &quot;</span> <span class="token operator">+</span> maxWaitMs <span class="token operator">+</span> <span class="token string">&quot; ms.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    remainingWaitMs <span class="token operator">=</span> maxWaitMs <span class="token operator">-</span> elapsed<span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// sender 更新成功后，调用此方法</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token class-name">Cluster</span> cluster<span class="token punctuation">,</span> <span class="token keyword">long</span> now<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">this</span><span class="token punctuation">.</span>needUpdate <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">this</span><span class="token punctuation">.</span>lastRefreshMs <span class="token operator">=</span> now<span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">this</span><span class="token punctuation">.</span>lastSuccessfulRefreshMs <span class="token operator">=</span> now<span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// version 变化</span></span>
<span class="line">  <span class="token keyword">this</span><span class="token punctuation">.</span>version <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Listener</span> listener<span class="token operator">:</span> listeners<span class="token punctuation">)</span></span>
<span class="line">    listener<span class="token punctuation">.</span><span class="token function">onMetadataUpdate</span><span class="token punctuation">(</span>cluster<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment">// Do this after notifying listeners as subscribed topics&#39; list can be changed by listeners</span></span>
<span class="line">  <span class="token keyword">this</span><span class="token punctuation">.</span>cluster <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>needMetadataForAllTopics <span class="token operator">?</span> <span class="token function">getClusterForCurrentTopics</span><span class="token punctuation">(</span>cluster<span class="token punctuation">)</span> <span class="token operator">:</span> cluster<span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">// 唤醒 wait 线程</span></span>
<span class="line">  <span class="token function">notifyAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Updated cluster metadata version {} to {}&quot;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>version<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>cluster<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul></li><li><p><code>sender</code>线程中，<code>long metadataTimeout = metadataUpdater.maybeUpdate(now);</code></p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@Override</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">maybeUpdate</span><span class="token punctuation">(</span><span class="token keyword">long</span> now<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token comment">// </span></span>
<span class="line">  <span class="token keyword">long</span> timeToNextMetadataUpdate <span class="token operator">=</span> metadata<span class="token punctuation">.</span><span class="token function">timeToNextUpdate</span><span class="token punctuation">(</span>now<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">// （上次没有可用Node的时间 + 重试间隔 - 当前时间）一般为负数</span></span>
<span class="line">  <span class="token keyword">long</span> timeToNextReconnectAttempt <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>lastNoNodeAvailableMs <span class="token operator">+</span> metadata<span class="token punctuation">.</span><span class="token function">refreshBackoff</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> now<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">// 是否存在已发送元数据更新请求，但没有返回结果？</span></span>
<span class="line">  <span class="token keyword">long</span> waitForMetadataFetch <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>metadataFetchInProgress <span class="token operator">?</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token constant">MAX_VALUE</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">// 取最大值</span></span>
<span class="line">  <span class="token keyword">long</span> metadataTimeout <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>timeToNextMetadataUpdate<span class="token punctuation">,</span> timeToNextReconnectAttempt<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">                                  waitForMetadataFetch<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">// 为0，执行可能更新方法</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>metadataTimeout <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 获取最空闲的节点</span></span>
<span class="line">    <span class="token class-name">Node</span> node <span class="token operator">=</span> <span class="token function">leastLoadedNode</span><span class="token punctuation">(</span>now<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">maybeUpdate</span><span class="token punctuation">(</span>now<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">return</span> metadataTimeout<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">long</span> <span class="token function">timeToNextUpdate</span><span class="token punctuation">(</span><span class="token keyword">long</span> nowMs<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token comment">// 强制更新？0: Math.max((上次更新时间 + 刷新元数据的间隔时间 - 当前时间),0)</span></span>
<span class="line">  <span class="token keyword">long</span> timeToExpire <span class="token operator">=</span> needUpdate <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>lastSuccessfulRefreshMs <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>metadataExpireMs <span class="token operator">-</span> nowMs<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">// （上次请求时间 + 重试间隔 - 当前时间）一般为负数</span></span>
<span class="line">  <span class="token keyword">long</span> timeToAllowUpdate <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lastRefreshMs <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>refreshBackoffMs <span class="token operator">-</span> nowMs<span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">return</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>timeToExpire<span class="token punctuation">,</span> timeToAllowUpdate<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token operator">-</span> `leastLoadedNode`：最空闲的节点</span>
<span class="line">  </span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">Node</span> <span class="token function">leastLoadedNode</span><span class="token punctuation">(</span><span class="token keyword">long</span> now<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Node</span><span class="token punctuation">&gt;</span></span> nodes <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>metadataUpdater<span class="token punctuation">.</span><span class="token function">fetchNodes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">int</span> inflight <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token constant">MAX_VALUE</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">Node</span> found <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">int</span> offset <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>randOffset<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span>nodes<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> nodes<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">int</span> idx <span class="token operator">=</span> <span class="token punctuation">(</span>offset <span class="token operator">+</span> i<span class="token punctuation">)</span> <span class="token operator">%</span> nodes<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token class-name">Node</span> node <span class="token operator">=</span> nodes<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">int</span> currInflight <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>inFlightRequests<span class="token punctuation">.</span><span class="token function">inFlightRequestCount</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span><span class="token function">idString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>currInflight <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>connectionStates<span class="token punctuation">.</span><span class="token function">isConnected</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span><span class="token function">idString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token comment">// if we find an established connection with no in-flight requests we can stop right away</span></span>
<span class="line">                <span class="token keyword">return</span> node<span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>connectionStates<span class="token punctuation">.</span><span class="token function">isBlackedOut</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span><span class="token function">idString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> now<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> currInflight <span class="token operator">&lt;</span> inflight<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token comment">// otherwise if this is the best we have found so far, record that</span></span>
<span class="line">                inflight <span class="token operator">=</span> currInflight<span class="token punctuation">;</span></span>
<span class="line">                found <span class="token operator">=</span> node<span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">return</span> found<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><h3 id="consumer" tabindex="-1"><a class="header-anchor" href="#consumer"><span>consumer</span></a></h3><p>kafka中的消费，是以组为单位：</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token comment">#查看消费组的消费偏移量</span></span>
<span class="line"><span class="token comment">#current-offset：当前消费组的已消费偏移量</span></span>
<span class="line"><span class="token comment">#log-end-offset：主题对应分区消息的结束偏移量(HW)</span></span>
<span class="line"><span class="token comment">#lag：当前消费组未消费的消息数</span></span>
<span class="line">bin/kafka-consumer-groups.sh --bootstrap-server localhost:9092 <span class="token parameter variable">--describe</span> <span class="token parameter variable">--group</span> testGroup-2</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="/blog/kafka.assets/image-20210601084800343.png" alt="image-20210601084800343"></p><h4 id="消费模式" tabindex="-1"><a class="header-anchor" href="#消费模式"><span>消费模式：</span></a></h4><ul><li>点对点：所有的<code>consumer</code>位于同一个<code>consumer group</code></li><li>发布订阅模式：每个<code>consumer</code>都有自己唯一的<code>consumer group</code></li></ul><p><img src="/blog/kafka.assets/image-20210531084930672.png" alt="image-20210531084930672"></p><p>说明：由两个<code>broker</code>组成的kafka集群，某个<code>topic</code>共有4个<code>partition</code>,共有两个<code>consumer group</code>去消费，<code>consumer group 1</code>有两个<code>consumer </code>,<code>consumer group 2</code> 有5个<code>consumer </code></p><blockquote><p>注意：<code>consumer group</code> 中如果<code>consumer </code>的数量 <code>大于</code>分区<code>partition</code>的数量，则会存在<code>consumer </code>消费不到数据的情况，不过多出来的可以用作<code>容灾备份</code></p></blockquote><h4 id="消费顺序" tabindex="-1"><a class="header-anchor" href="#消费顺序"><span>消费顺序：</span></a></h4><p>Kafka只在<code>partition</code>的范围内保证消费的局部顺序性，不能再同一个<code>topic</code>的多个<code>partition</code>中保证总的消费顺序性，</p><blockquote><p>如果非要保证总体上的顺序消费，可以将<code>topic</code>的<code>partition</code>数量设置为1，将<code>consumer group</code>中的<code>consumer </code>数量也设置为1</p></blockquote><h4 id="消费者客户端" tabindex="-1"><a class="header-anchor" href="#消费者客户端"><span>消费者客户端</span></a></h4><h5 id="必要的参数配置" tabindex="-1"><a class="header-anchor" href="#必要的参数配置"><span>必要的参数配置：</span></a></h5><blockquote><p><code>org.apache.kafka.clients.consumer.ConsumerConfig</code></p></blockquote><ul><li><code>bootstrap.servers</code>：host1:port1,host2:port2</li><li><code>group.id</code>：消费组</li><li><code>key.deserializer</code>：</li><li><code>value.deserializer</code>：</li></ul><h5 id="订阅主题与分区" tabindex="-1"><a class="header-anchor" href="#订阅主题与分区"><span>订阅主题与分区</span></a></h5><blockquote><p>Tips：同一种订阅模式重复订阅会覆盖，不同模式会报错</p></blockquote><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token comment">// SubscriptionType.AUTO_TOPICS</span></span>
<span class="line"><span class="token comment">// 指定topic</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> topics<span class="token punctuation">,</span> <span class="token class-name">ConsumerRebalanceListener</span> listener<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> topics<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// SubscriptionType.AUTO_PATTERN</span></span>
<span class="line"><span class="token comment">// 正则匹配topicName</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token class-name">Pattern</span> pattern<span class="token punctuation">,</span> <span class="token class-name">ConsumerRebalanceListener</span> listener<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token class-name">Pattern</span> pattern<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// SubscriptionType.USER_ASSIGNED</span></span>
<span class="line"><span class="token comment">// 指定topic + 分区</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">assign</span><span class="token punctuation">(</span><span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TopicPartition</span><span class="token punctuation">&gt;</span></span> partitions<span class="token punctuation">)</span> </span>
<span class="line"></span>
<span class="line"></span>
<span class="line">  <span class="token comment">// 再均衡监听器</span></span>
<span class="line">  consumer<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">singletonList</span><span class="token punctuation">(</span><span class="token constant">TOPIC_NAME</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ConsumerRebalanceListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onPartitionsRevoked</span><span class="token punctuation">(</span><span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TopicPartition</span><span class="token punctuation">&gt;</span></span> partitions<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token comment">// partitions 再均衡之前分配的分区信息</span></span>
<span class="line">      <span class="token comment">// 可以做位移提交操作</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onPartitionsAssigned</span><span class="token punctuation">(</span><span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TopicPartition</span><span class="token punctuation">&gt;</span></span> partitions<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token comment">// 再均衡之后，分配到的分区信息</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="反序列化" tabindex="-1"><a class="header-anchor" href="#反序列化"><span>反序列化</span></a></h5><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Deserializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">Closeable</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">default</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">&gt;</span></span> configs<span class="token punctuation">,</span> <span class="token keyword">boolean</span> isKey<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token class-name">T</span> <span class="token function">deserialize</span><span class="token punctuation">(</span><span class="token class-name">String</span> topic<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">default</span> <span class="token class-name">T</span> <span class="token function">deserialize</span><span class="token punctuation">(</span><span class="token class-name">String</span> topic<span class="token punctuation">,</span> <span class="token class-name">Headers</span> headers<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token function">deserialize</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token keyword">default</span> <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 默认的 字符串反序列化实现</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StringDeserializer</span> <span class="token keyword">implements</span> <span class="token class-name">Deserializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">String</span> encoding <span class="token operator">=</span> <span class="token string">&quot;UTF8&quot;</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// .....</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">deserialize</span><span class="token punctuation">(</span><span class="token class-name">String</span> topic<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>data <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span></span>
<span class="line">                <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">else</span></span>
<span class="line">                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> encoding<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">UnsupportedEncodingException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">SerializationException</span><span class="token punctuation">(</span><span class="token string">&quot;Error when deserializing byte[] to string due to unsupported encoding &quot;</span> <span class="token operator">+</span> encoding<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token comment">// ....</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="位移提交" tabindex="-1"><a class="header-anchor" href="#位移提交"><span>位移提交</span></a></h5><blockquote><p>offset：Topic每个分区下每条消息唯一的<code>offset</code>值</p><p>存储：kafka 提供了一个内部 topic <code>_consumer_offsets</code> 来存储所有<code>consumerGroup</code>的offset信息，默认50个分区，可以通过<code>offsets.topic.num.partitions</code>指定</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token comment"># 存储的分区计算：</span></span>
<span class="line">Math.abs<span class="token punctuation">(</span><span class="token string">&quot;consumerGropuID&quot;</span>.hashCode<span class="token punctuation">(</span><span class="token punctuation">))</span> % <span class="token number">50</span></span>
<span class="line"><span class="token comment"># 查看提交记录</span></span>
<span class="line">bin/kafka-simple-consumer-shell.sh <span class="token parameter variable">--topic</span> __consumer_offsets <span class="token parameter variable">--partition</span> <span class="token number">49</span> --broker-list <span class="token number">172.20</span>.39.2:9092 <span class="token parameter variable">--formatter</span> <span class="token string">&quot;kafka.coordinator.GroupMetadataManager\<span class="token variable">$OffsetsMessageFormatter</span>&quot;</span> </span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="/blog/kafka.assets/image-20210805192328049.png" alt="image-20210805192328049"></p><p>消费者消费完消息后，进行消息的提交,提交的 <code>offset</code> 值为当前消费的<code>最大offset +1 </code></p><p><img src="/blog/kafka.assets/image-20210806082425949.png" alt="image-20210806082425949"></p></blockquote><h6 id="offset提交流程" tabindex="-1"><a class="header-anchor" href="#offset提交流程"><span><code>offset</code>提交流程：</span></a></h6><ul><li>consumer执行poll时，先请求服务端，获取当前（consummerGroup、topic、partition）需要消费的<code>offset</code>值，且本地缓存<code>Map&lt;TopicPartition, TopicPartitionState&gt; </code></li><li>当<code>poll</code>拉取到消息后，更新本地缓存的<code>TopicPartitionState 中的 position</code>值为最后一条record 的 offset值</li><li>自动提交(默认)： <ul><li>每隔 5s(可配置)，将拉取到的各个分区的最大位移值进行提交，且为异步提交方式 <ul><li>消息丢失：位移已经提交，消费消费出现异常</li><li>消息重复消费：有五秒延时，已消费完成部分数据，但未提交时，出现异常</li></ul></li></ul></li><li>手动提交： <ul><li>显示执行：consumer.commitSync(); 或者 consumer.commitAsync();</li><li>consumer.commitSync() <ul><li>会阻塞，性能略差，如果程序消费至一半，出现异常，没有提交位移，则会发生重复消费的问题</li></ul></li><li>consumer.commitAsync() <ul><li>异步提交方式，可以提供callback参数，对提交结果做相应处理，但是如果真的提交失败了，依然会存在一些问题：比如同时两个异步提交的请求，第一个失败了，第二个成功了，代码中对失败的处理为重试，第一个失败后重试又成功了，则会覆盖第二次的提交offse，所以并没有完美的解决方案；更何况一般情况下位移提交也不会失败。</li></ul></li></ul></li></ul><h6 id="配置参数" tabindex="-1"><a class="header-anchor" href="#配置参数"><span>配置参数：</span></a></h6><ul><li><p><code>enable.auto.commit</code>: 是否自动提交 true/false</p></li><li><p><code>auto.commit.interval.ms</code>: 为自动提交时，自动提交的时间间隔</p></li></ul><h4 id="指定位移消费" tabindex="-1"><a class="header-anchor" href="#指定位移消费"><span>指定位移消费</span></a></h4><blockquote><p><code>auto.offset.reset</code>:</p><ul><li>latest（默认）:只消费自己启动之后发送到主题的消息</li><li>earliest：第一次从头开始消费，以后按照消费消费组offset记录继续消费，这个需要区别于consumer.seekToBeginning(每次都从头开始消费)</li><li>none：当前消费组没有消费位移记录时，抛出异常<code>NoOffsetForPartitionException</code></li></ul></blockquote><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token comment">// api 优先于 auto.offset.reset</span></span>
<span class="line"><span class="token comment">// 从头开始消费</span></span>
<span class="line">consumer<span class="token punctuation">.</span><span class="token function">seekToBeginning</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TopicPartition</span><span class="token punctuation">(</span><span class="token constant">TOPIC_NAME</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 指定位移消费</span></span>
<span class="line">consumer<span class="token punctuation">.</span><span class="token function">seek</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TopicPartition</span><span class="token punctuation">(</span><span class="token constant">TOPIC_NAME</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 0.11.x 版本增加：从指定时间点开始消费</span></span>
<span class="line"><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PartitionInfo</span><span class="token punctuation">&gt;</span></span> topicPartitions <span class="token operator">=</span> consumer<span class="token punctuation">.</span><span class="token function">partitionsFor</span><span class="token punctuation">(</span><span class="token constant">TOPIC_NAME</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">// 从1小时前开始消费</span></span>
<span class="line"><span class="token keyword">long</span> fetchDataTime <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TopicPartition</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">PartitionInfo</span> par <span class="token operator">:</span> topicPartitions<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TopicPartition</span><span class="token punctuation">(</span>topicName<span class="token punctuation">,</span> par<span class="token punctuation">.</span><span class="token function">partition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> fetchDataTime<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token comment">// 根据时间拿到 offset值</span></span>
<span class="line"><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TopicPartition</span><span class="token punctuation">,</span> <span class="token class-name">OffsetAndTimestamp</span><span class="token punctuation">&gt;</span></span> parMap <span class="token operator">=</span> consumer<span class="token punctuation">.</span><span class="token function">offsetsForTimes</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TopicPartition</span><span class="token punctuation">,</span> <span class="token class-name">OffsetAndTimestamp</span><span class="token punctuation">&gt;</span></span> entry <span class="token operator">:</span> parMap<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token class-name">TopicPartition</span> key <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token class-name">OffsetAndTimestamp</span> value <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> value <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token class-name">Long</span> offset <span class="token operator">=</span> value<span class="token punctuation">.</span><span class="token function">offset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;partition-&quot;</span> <span class="token operator">+</span> key<span class="token punctuation">.</span><span class="token function">partition</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;|offset-&quot;</span> <span class="token operator">+</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">//根据消费里的timestamp确定offset</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    consumer<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">// 指定位移消费</span></span>
<span class="line">    consumer<span class="token punctuation">.</span><span class="token function">seek</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="rebalance机制" tabindex="-1"><a class="header-anchor" href="#rebalance机制"><span>Rebalance机制</span></a></h4><blockquote><p>指的是当消费组中的消费者数量发生变化或者消费的topic分区数发生变化时，kafka重新分配消费者消费分区的关系；比如：消费组中某个消费者挂掉了，此时会将分配给它的分区交给其他消费者，如果它又重启了，则又会把一些分区分配给它</p></blockquote><h5 id="触发rebalance机制" tabindex="-1"><a class="header-anchor" href="#触发rebalance机制"><span><strong>触发<code>Rebalance</code>机制：</strong></span></a></h5><ul><li>有新的消费者加入消费组</li><li>有消费者宕机下线，也可能并非真正的下线，如遇到网络延迟情况，长时间未和<code>GroupCoordinator</code>发送心跳，<code>GroupCoordinator</code>会认为消费者下线</li><li>有消费者主动退出消费组,比如调用<code>unsubscribe()</code></li><li>消费组对应的<code>GroupCoordinator</code>节点发生变化</li><li>订阅的主题或主题的分区发生变化</li></ul><p><strong>注意</strong>：</p><ul><li>如果消费者通过<code>assign</code> Api指定分区消费，则此消费者不会<code>Rebalance</code></li><li><code>Rebalance</code>过程中，消费者无法从kafka消费消息，所以应当避免高峰期<code>Rebalance</code>发生</li></ul><h5 id="rebalance-策略" tabindex="-1"><a class="header-anchor" href="#rebalance-策略"><span><strong>Rebalance 策略：</strong></span></a></h5><p>假设当前10个分区(0~9) , 消费组下3个 consumer</p><ul><li><strong>range</strong>(默认): m = 分区数 % 消费者数 = 1；n = 分区数 / 消费者数 = 3，则前 m 个消费者 消费分区 n+1 个，剩余消费者消费分区n <ul><li>分区 0~3 分配给consumer1；4~6 分配给consumer2；7~9分配给consumer3</li></ul></li><li><strong>round-robin</strong>：轮询分配方式 <ul><li>0、3、6、9 分配给consumer1；1、4、7分配给consumer2；2、5、8分配给consumer3</li></ul></li><li><strong>sticky</strong>：0.11.x版本增加，类似黏性的<code>range</code><ul><li>原则： <ul><li>分配尽可能均匀</li><li>分配尽可能与上次分配保持相同</li></ul></li><li>如：分区 0~3 分配给consumer1；4~6 分配给consumer2；7~9分配给consumer3，当 consumer3 挂掉后 <ul><li><code>rang</code>：0~4 分配给consumer1，5~9 分配给consumer2</li><li><code>sticky</code>：0~3 、7 分配给 consumer1，4~6、8、9 分配给 consumer2（尽量保持和上次分配相同）</li></ul></li></ul></li></ul><h5 id="rebalance-过程" tabindex="-1"><a class="header-anchor" href="#rebalance-过程"><span><strong>Rebalance 过程</strong>：</span></a></h5><h6 id="组件" tabindex="-1"><a class="header-anchor" href="#组件"><span>组件：</span></a></h6><p><strong>组协调器<code>GroupCoordinator</code></strong>：每个consumer group都会选择一个broker作为自己的组协调器coordinator，负责监控这个消费组里的所有消费者的心跳，以及判断是否宕机，然后开启消费者rebalance</p><p><strong>消费者协调器<code>ConsumerCoordinator</code></strong>：每个consumer都会构造自己的协调器，与<code>GroupCoordinator</code>进行交互，形成消费者和服务端之间的桥梁</p><blockquote><p>消费者协调器主要负责如下工作：</p><ul><li><p>更新消费者缓存的MetaData</p></li><li><p>查找组协调器</p></li><li><p>向组协调器申请加入组</p></li><li><p>请求离开消费组</p></li><li><p>向组协调器提交偏移量</p></li><li><p>通过心跳，保持组协调器的连接感知。</p></li><li><p>被组协调器选为leader的消费者的协调器，负责消费者分区分配。分配结果发送给组协调器。</p></li><li><p>非leader的消费者，通过消费者协调器和组协调器同步分配结果。</p></li></ul></blockquote><h6 id="过程" tabindex="-1"><a class="header-anchor" href="#过程"><span>过程</span></a></h6><p><img src="/blog/kafka.assets/image-20220127114954375.png" alt="image-20220127114954375"></p><ol><li><p>找到<code>GroupCoordinator</code></p><ul><li><p>向集群中的某个节点发送<code>FindCoordinatorRequest</code></p><ul><li>非随机节点，是之前提到过的<code>leastLoadedNode</code></li></ul></li><li><p>当前消费组<code>offset</code>所要提交至<code>_consumer_offset</code>topic的哪个分区，则此分区的 <code>leader</code>节点broker，就是当前消费组的<code>GroupCoordinator</code></p></li></ul></li><li><p>加入消费组<code>JOIN Group</code> &amp; 分区方案制定</p><ul><li>在成功找到消费组所对应的 <code>GroupCoordinator</code> 之后就进入加入消费组的阶段，在此阶段的消费者会向 <code>GroupCoordinator</code> 发送 <code>JoinGroupRequest</code> 请求，并处理响应。然后GroupCoordinator 从一个consumer group中选择第一个加入group的consumer作为<code>leader</code>，把consumer group情况发送给这个leader，接着这个leader会负责制定分区方案。 <ul><li>如果消费组内的<code>leader</code>由于某些情况退出了消费组，则在消费组内的消费者列表中，随机选择一个作为<code>leader</code></li></ul></li><li>做一些其他事情 <ul><li>如果为自动提交，则在发送<code>JoinGroupRequest</code> 之前，需要同步提交<code>offset</code></li><li>如果配置了<code>ConsumerRebalanceListener</code>,需要调用<code>onPartitionsRevoked</code></li></ul></li></ul></li><li><p>同步分区数据<code>SYNC_GROUP</code></p><ul><li>consumer leader通过给<code>GroupCoordinator</code>发送 <code>SyncGroupRequest</code>，同时将分区方案，发送至 <code>GropCoordinator</code></li><li>非 leader consumer 也向<code> GroupCoordinator</code> 发送 <code>SyncGroupRequest</code></li><li><code>SyncGroupResponseHandler</code>响应中，返回 分区方案，并更新本地分区方案数据</li><li>再根据指定分区的leader broker进行网络连接以及消息消费。</li><li>如果配置了<code>ConsumerRebalanceListener</code>,需要调用<code>onPartitionsAssigned</code></li></ul></li></ol><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token comment">// 客户端、服务端 交互关键类</span></span>
<span class="line"><span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>common<span class="token punctuation">.</span>protocol<span class="token punctuation">.</span></span>ApiKeys</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 消费者拉取过程</span></span>
<span class="line">		<span class="token comment">// 循环 确保协调器准备好了 GroupCoordinator</span></span>
<span class="line">    <span class="token function">poll</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>common<span class="token punctuation">.</span>utils<span class="token punctuation">.</span></span>Timer</span><span class="token punctuation">,</span> <span class="token keyword">boolean</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token comment">// 更新topic、partition 信息</span></span>
<span class="line">        <span class="token function">updateAssignmentMetadataIfNeeded</span><span class="token punctuation">(</span>timer<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            coordinator<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span>timer<span class="token punctuation">,</span> waitForJoinGroup<span class="token punctuation">)</span></span>
<span class="line">                <span class="token comment">// 查找组协调器，设置 AbstractCoordinator.this.coordinator value</span></span>
<span class="line">                <span class="token function">ensureCoordinatorReady</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span></span>
<span class="line">                    <span class="token function">lookupCoordinator</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">                        <span class="token comment">// 构造FindCoordinatorRequest,放到缓存中</span></span>
<span class="line">                        unsent<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> clientRequest<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                    <span class="token comment">// 拉取 unset 中的数据，发送请求</span></span>
<span class="line">                    client<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span>future<span class="token punctuation">,</span> timer<span class="token punctuation">)</span></span>
<span class="line">                <span class="token comment">// 判断是否需要 join group</span></span>
<span class="line">                <span class="token function">rejoinNeededOrPending</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">                <span class="token comment">// 加入组</span></span>
<span class="line">                <span class="token function">ensureActiveGroup</span><span class="token punctuation">(</span>waitForJoinGroup <span class="token operator">?</span> timer <span class="token operator">:</span> time<span class="token punctuation">.</span><span class="token function">timer</span><span class="token punctuation">(</span><span class="token number">0L</span><span class="token punctuation">)</span></span>
<span class="line">                    <span class="token comment">// 启动 心跳线程</span></span>
<span class="line">                    <span class="token function">startHeartbeatThreadIfNeeded</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">                    <span class="token comment">// 加入消费组</span></span>
<span class="line">                    <span class="token function">joinGroupIfNeeded</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span></span>
<span class="line">                        <span class="token comment">// 分区变化前的方法调用</span></span>
<span class="line">                        <span class="token function">onJoinPrepare</span><span class="token punctuation">(</span>generation<span class="token punctuation">.</span>generationId<span class="token punctuation">,</span> generation<span class="token punctuation">.</span>memberId<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                        <span class="token comment">// 构造加入请求</span></span>
<span class="line">                        <span class="token function">initiateJoinGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">                        <span class="token comment">// 发送加入请求，并等待加入完成</span></span>
<span class="line">                        client<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span>future<span class="token punctuation">,</span> timer<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                            <span class="token comment">// 加入成功之后的回调</span></span>
<span class="line">                            <span class="token class-name">JoinGroupResponseHandler</span>#handle</span>
<span class="line">                                <span class="token comment">// 如果当前节点为 leader，进行分区 和 consumer 绑定划分</span></span>
<span class="line">                                <span class="token comment">// 非leader节点，也发送 syncGroupRequest</span></span>
<span class="line">                                <span class="token function">onJoinLeader</span><span class="token punctuation">(</span>joinResponse<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">chain</span><span class="token punctuation">(</span>future<span class="token punctuation">)</span></span>
<span class="line">                                    <span class="token comment">// 完成分区分配后，发送 SyncGroup,回调 SyncGroupResponseHandler</span></span>
<span class="line">                                    client<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>coordinator<span class="token punctuation">,</span> requestBuilder<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">compose</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SyncGroupResponseHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">                                    <span class="token comment">// 同步回调方法</span></span>
<span class="line">                                    <span class="token class-name">SyncGroupResponseHandler</span>#handle</span>
<span class="line">                                        <span class="token comment">// 将分区分配信息，赋值给 future 对象，此future 对象就是 joinGroup时，生成的</span></span>
<span class="line">                                        future<span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span><span class="token class-name">ByteBuffer</span><span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>syncResponse<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token function">assignment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">                        <span class="token comment">// 加入完成方法</span></span>
<span class="line">                        <span class="token function">onJoinComplete</span><span class="token punctuation">(</span></span>
<span class="line">                            <span class="token comment">// 更新本地消费的topic分区信息</span></span>
<span class="line">                            subscriptions<span class="token punctuation">.</span><span class="token function">assignFromSubscribed</span><span class="token punctuation">(</span>assignedPartitions<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                            <span class="token comment">// 调用分区变更后的方法</span></span>
<span class="line">                            firstException<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span></span>
<span class="line">        <span class="token comment">// 更新本地 offset                    </span></span>
<span class="line">        <span class="token function">updateFetchPositions</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span>                        </span>
<span class="line">				<span class="token comment">// 拉取数据</span></span>
<span class="line">        <span class="token function">pollForFetches</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span></span>
<span class="line">            <span class="token comment">// 请求真正的业务数据</span></span>
<span class="line">            fetcher<span class="token punctuation">.</span><span class="token function">sendFetches</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token comment">// 按每个分区循环发送数据请求，因为分区不同，leader不同，请求的节点不同</span></span>
<span class="line">                <span class="token function">prepareFetchRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token comment">// 接收响应数据,</span></span>
<span class="line">            client<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span></span>
<span class="line">            <span class="token comment">// 按最大数量，拉取缓存中的数据</span></span>
<span class="line">            fetcher<span class="token punctuation">.</span><span class="token function">fetchedRecords</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>旧版客户端存在问题</strong>：</p><p>在zk中维护的节点信息：</p><ul><li>消费组：<code>/consumers/&lt;group&gt;/ids</code></li><li>broker：<code>brokers/ids/&lt;id&gt;</code></li><li>Topic：<code>/brokers/topics/&lt;topic&gt;</code></li><li>partition：<code>/brokers/topics/&lt;topic&gt;/partitions/&lt;partition&gt;/state</code></li><li>......</li></ul><p>因为zk中很多节点信息发生变化时，都会触发再均衡操作，所以每个消费者都需要在每条相关路径注册<code>Watcher</code>,这种严重依赖zk集群的做法有两个严重的问题：</p><ul><li><strong>羊群效应</strong>：指的是zk中一个被监听的节点发生变化，大量的<code>Watcher</code>通知被发送至客户端，导致其他操作将被延迟，也可能发生类似死锁的情况</li><li><strong>脑裂问题</strong>：消费者进行再均衡操作时每个消费者都与zk通信，以判断消费者或broker变化的情况，由于zk自身的特性，可能导致在同一时刻各个消 费者获取的状态不一致，这样会导致异常问题发生。</li></ul><h4 id="多线程实现" tabindex="-1"><a class="header-anchor" href="#多线程实现"><span>多线程实现</span></a></h4><ul><li><code>producer</code> 是线程安全的，多个线程可以同时一个<code>producer</code>实例使用发送信息</li><li><code>consumer</code> 非线程安全 <ul><li><code>acquireAndEnsureOpen();</code>判断如果有多个线程在操作，会抛出异常</li></ul></li><li>多线程实现方式： <ul><li>每个线程，实例化一个 <code>KafkaConsumer</code>对象，就相当于启动了 多个<code>consumer</code>节点</li><li>一个<code>KafkaConsumer</code>对象去<code>poll</code>消息，处理消息使用多线程 <ul><li>这样方式下，因为多线程之间无序处理， <code>手动提交offset</code>会变得比较复杂，最好使用<code>自动提交offset</code></li></ul></li></ul></li></ul><h4 id="重要的消费者参数" tabindex="-1"><a class="header-anchor" href="#重要的消费者参数"><span>重要的消费者参数</span></a></h4><ul><li><code>fetch.min.bytes</code> 和 <code>fetch.max.wait.ms</code>：调用<code>poll()</code>方法，需要拉取到的最小数据量，<code>fetch.min.bytes(默认1B)</code>；当kafka返回给consumer的数据量小于此值，则会继续等待，直到数据量大于等于此配置，或超过 <code>fetch.max.wait.ms（默认500）</code>配置的时间；适当调大此参数可以提高一定的吞吐量，但是也会有一定延迟</li><li><code>enable.auto.commit</code>：是否自动提交，默认<code>是</code></li><li><code>auto.commit.interval.ms</code>：自动提交时，时间间隔,默认<code>5000</code></li><li><code>auto.offset.reset</code>: <ul><li>latest（默认）:只消费自己启动之后发送到主题的消息</li><li>earliest：第一次从头开始消费，以后按照消费offset记录继续消费，这个需要区别于consumer.seekToBeginning(每次都从头开始消费)</li><li>none：当前消费组没有消费位移记录时，抛出异常<code>NoOffsetForPartitionException</code></li></ul></li><li><code>heartbeat.interval.ms</code>: consumer 和 group coordinator 心跳的间隔时间，若发生了 rebalance，consumer 收到的响应中会包含REBALANCE_IN_PROGRESS. <ul><li>必须小于<code>session.timeout.ms</code></li><li>默认<code>3000</code></li></ul></li><li><code>session.timeout.ms</code>: 多长时间未感知到心跳，则认为<code>consumer</code>挂掉了，会将其踢出消费组 <ul><li>0.10.1 版本之前是 <code>30000</code></li><li>0.10.1 版本之后是 <code>10000</code></li></ul></li><li><code>max.poll.interval.ms</code>：0.10.1版本后才有，在这之前<code>发送心跳包</code>和<code>消息处理逻辑</code>这2个过程是耦合在一起的，试想：如果一条消息处理时长要5min，而session.timeout.ms=3000ms，那么等 kafka consumer处理完消息，因为只有一个线程，在消息处理过程中就无法向group coordinator发送心跳包，超过3000ms未发送心跳包，group coordinator就将该consumer移出group了；而将二者分开，一个线程负责执行消息处理逻辑，一个线程负责发送心跳包，那么：就算一条消息需要处理5min，只要heartbeat线程在session.timeout.ms 向 group coordinator发送了心跳包，那consumer可以继续处理消息，而不用担心被移出group了，所以 0.10.1 版本后，<code>session.timeout.ms</code> 默认值发生变化</li><li><code>max.poll.records</code>：每次<code>poll</code>最大拉取条数，默认 <code>500</code></li></ul><h4 id="问题-1" tabindex="-1"><a class="header-anchor" href="#问题-1"><span>问题</span></a></h4><ul><li>内部topic默认几个副本 <ul><li>跟随 server端配置的默认副本数 <code>default.replication.factor</code>,默认为 1</li></ul></li></ul><h3 id="日志存储" tabindex="-1"><a class="header-anchor" href="#日志存储"><span>日志存储</span></a></h3><h4 id="文件目录布局" tabindex="-1"><a class="header-anchor" href="#文件目录布局"><span>文件目录布局</span></a></h4><p>kafka会根据配置的日志保留时间(<code>log.retention.hours</code>)确认消息多久被删除，默认保留最近一周的日志消息</p><p>一个分区的消息数据对应存储在一个文件夹下，以topic名称+分区号命名，消息在分区内是分段(segment)存储，每个段的消息都存储在不一样的log文件里，这种特性方便old segment file快速被删除，kafka规定了一个段位的 log 文件最大为 1G，做这个限制目的是为了方便把 log 文件加载到内存去操作：</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token comment"># 文件名称表示当前文件offset的开始值</span></span>
<span class="line"><span class="token comment"># 部分消息的offset索引文件，kafka每次往分区发4K(log.index.interval.bytes)消息就会记录一条当前消息的offset到index文件</span></span>
<span class="line"><span class="token comment"># 如果要定位消息的offset会先在这个文件里快速定位，再去log文件里找具体消息</span></span>
<span class="line">00000000000000000000.index</span>
<span class="line"><span class="token comment"># 消息存储文件，主要存offset和消息体</span></span>
<span class="line">00000000000000000000.log</span>
<span class="line"><span class="token comment"># 消息的发送时间索引文件，kafka每次往分区发4K(log.index.interval.bytes)消息就会记录一条当前消息的发送时间戳与对应的offset到timeindex文件，</span></span>
<span class="line"><span class="token comment"># 如果需要按照时间来定位消息的offset，会先在这个文件里查找</span></span>
<span class="line">00000000000000000000.timeindex</span>
<span class="line">00000000000005367851.index</span>
<span class="line">00000000000005367851.log</span>
<span class="line">00000000000005367851.timeindex</span>
<span class="line"></span>
<span class="line">00000000000009936472.index</span>
<span class="line">00000000000009936472.log</span>
<span class="line">00000000000009936472.timeindex</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>我们知道consumer提交的offset是保存在内部topic<code>_consumer_offset</code>中，初始情况下，这个主题并不存在，当第一次有消费者消费消息时，会自动创建这个主题</p><h4 id="消息压缩" tabindex="-1"><a class="header-anchor" href="#消息压缩"><span>消息压缩</span></a></h4><h3 id="zookeeper存储" tabindex="-1"><a class="header-anchor" href="#zookeeper存储"><span>Zookeeper存储</span></a></h3><p><img src="https://note.youdao.com/yws/public/resource/d9fed88c81ff75e6c0e6364012d19fef/xmlnote/2F76FF53FBF643E785B18CD0F0C2D3D2/83219" alt="img"></p><h2 id="扩展" tabindex="-1"><a class="header-anchor" href="#扩展"><span>扩展</span></a></h2><h3 id="efak" tabindex="-1"><a class="header-anchor" href="#efak"><span>EFAK</span></a></h3><blockquote><p>参考：https://www.cnblogs.com/smartloli/p/9371904.html</p><p>下载：http://download.smartloli.org/</p><p>配置环境变量：</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token builtin class-name">export</span> <span class="token assign-left variable">KE_HOME</span><span class="token operator">=</span>/home/hadoop/kafka/kafka-eagle-bin-2.0.8/efak-web-2.0.8</span>
<span class="line"><span class="token builtin class-name">export</span> <span class="token assign-left variable"><span class="token environment constant">PATH</span></span><span class="token operator">=</span><span class="token environment constant">$PATH</span><span class="token builtin class-name">:</span><span class="token variable">$KE_HOME</span>/bin</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>修改配置文件</p><div class="language-properties line-numbers-mode" data-highlighter="prismjs" data-ext="properties" data-title="properties"><pre><code><span class="line"><span class="token comment">######################################</span></span>
<span class="line"><span class="token comment"># multi zookeeper &amp; kafka cluster list</span></span>
<span class="line"><span class="token comment"># Settings prefixed with &#39;kafka.eagle.&#39; will be deprecated, use &#39;efak.&#39; instead</span></span>
<span class="line"><span class="token comment">######################################</span></span>
<span class="line"><span class="token key attr-name">efak.zk.cluster.alias</span><span class="token punctuation">=</span><span class="token value attr-value">cluster1</span></span>
<span class="line"><span class="token key attr-name">cluster1.zk.list</span><span class="token punctuation">=</span><span class="token value attr-value">172.20.39.2:2181/kafka/product/kafka281</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">######################################</span></span>
<span class="line"><span class="token comment"># zookeeper enable acl</span></span>
<span class="line"><span class="token comment">######################################</span></span>
<span class="line"><span class="token comment">#cluster1.zk.acl.enable=false</span></span>
<span class="line"><span class="token comment">#cluster1.zk.acl.schema=digest</span></span>
<span class="line"><span class="token comment">#cluster1.zk.acl.username=test</span></span>
<span class="line"><span class="token comment">#cluster1.zk.acl.password=test123</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">######################################</span></span>
<span class="line"><span class="token comment"># broker size online list</span></span>
<span class="line"><span class="token comment">######################################</span></span>
<span class="line"><span class="token key attr-name">cluster1.efak.broker.size</span><span class="token punctuation">=</span><span class="token value attr-value">20</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">######################################</span></span>
<span class="line"><span class="token comment"># zk client thread limit</span></span>
<span class="line"><span class="token comment">######################################</span></span>
<span class="line"><span class="token key attr-name">kafka.zk.limit.size</span><span class="token punctuation">=</span><span class="token value attr-value">32</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">######################################</span></span>
<span class="line"><span class="token comment"># EFAK webui port</span></span>
<span class="line"><span class="token comment">######################################</span></span>
<span class="line"><span class="token key attr-name">efak.webui.port</span><span class="token punctuation">=</span><span class="token value attr-value">8048</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">######################################</span></span>
<span class="line"><span class="token comment"># kafka jmx acl and ssl authenticate</span></span>
<span class="line"><span class="token comment">######################################</span></span>
<span class="line"><span class="token key attr-name">cluster1.efak.jmx.acl</span><span class="token punctuation">=</span><span class="token value attr-value">false</span></span>
<span class="line"><span class="token key attr-name">cluster1.efak.jmx.user</span><span class="token punctuation">=</span><span class="token value attr-value">keadmin</span></span>
<span class="line"><span class="token key attr-name">cluster1.efak.jmx.password</span><span class="token punctuation">=</span><span class="token value attr-value">keadmin123</span></span>
<span class="line"><span class="token key attr-name">cluster1.efak.jmx.ssl</span><span class="token punctuation">=</span><span class="token value attr-value">false</span></span>
<span class="line"><span class="token key attr-name">cluster1.efak.jmx.truststore.location</span><span class="token punctuation">=</span><span class="token value attr-value">/data/ssl/certificates/kafka.truststore</span></span>
<span class="line"><span class="token key attr-name">cluster1.efak.jmx.truststore.password</span><span class="token punctuation">=</span><span class="token value attr-value">ke123456</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">######################################</span></span>
<span class="line"><span class="token comment"># kafka offset storage</span></span>
<span class="line"><span class="token comment">######################################</span></span>
<span class="line"><span class="token key attr-name">cluster1.efak.offset.storage</span><span class="token punctuation">=</span><span class="token value attr-value">kafka</span></span>
<span class="line"><span class="token comment">#cluster2.efak.offset.storage=zk</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">######################################</span></span>
<span class="line"><span class="token key attr-name">cluster1.efak.jmx.uri</span><span class="token punctuation">=</span><span class="token value attr-value">service:jmx:rmi:///jndi/rmi://%s/jmxrmi</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">######################################</span></span>
<span class="line"><span class="token comment"># kafka metrics, 15 days by default</span></span>
<span class="line"><span class="token comment">######################################</span></span>
<span class="line"><span class="token key attr-name">efak.metrics.charts</span><span class="token punctuation">=</span><span class="token value attr-value">true</span></span>
<span class="line"><span class="token key attr-name">efak.metrics.retain</span><span class="token punctuation">=</span><span class="token value attr-value">15</span></span>
<span class="line"><span class="token comment"># kafka sql topic records max</span></span>
<span class="line"><span class="token comment">######################################</span></span>
<span class="line"><span class="token key attr-name">efak.sql.topic.records.max</span><span class="token punctuation">=</span><span class="token value attr-value">5000</span></span>
<span class="line"><span class="token key attr-name">efak.sql.topic.preview.records.max</span><span class="token punctuation">=</span><span class="token value attr-value">10</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">######################################</span></span>
<span class="line"><span class="token comment"># delete kafka topic token</span></span>
<span class="line"><span class="token comment">######################################</span></span>
<span class="line"><span class="token key attr-name">efak.topic.token</span><span class="token punctuation">=</span><span class="token value attr-value">keadmin</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">######################################</span></span>
<span class="line"><span class="token comment"># kafka sasl authenticate</span></span>
<span class="line"><span class="token comment">######################################</span></span>
<span class="line"><span class="token key attr-name">cluster1.efak.sasl.enable</span><span class="token punctuation">=</span><span class="token value attr-value">false</span></span>
<span class="line"><span class="token key attr-name">cluster1.efak.sasl.protocol</span><span class="token punctuation">=</span><span class="token value attr-value">SASL_PLAINTEXT</span></span>
<span class="line"><span class="token key attr-name">cluster1.efak.sasl.mechanism</span><span class="token punctuation">=</span><span class="token value attr-value">SCRAM-SHA-256</span></span>
<span class="line"><span class="token key attr-name">cluster1.efak.sasl.client.id</span><span class="token punctuation">=</span></span>
<span class="line"><span class="token key attr-name">cluster1.efak.blacklist.topics</span><span class="token punctuation">=</span></span>
<span class="line"><span class="token key attr-name">cluster1.efak.sasl.cgroup.enable</span><span class="token punctuation">=</span><span class="token value attr-value">false</span></span>
<span class="line"><span class="token key attr-name">cluster1.efak.sasl.cgroup.topics</span><span class="token punctuation">=</span></span>
<span class="line"><span class="token key attr-name">cluster2.efak.sasl.enable</span><span class="token punctuation">=</span><span class="token value attr-value">false</span></span>
<span class="line"><span class="token key attr-name">cluster2.efak.sasl.protocol</span><span class="token punctuation">=</span><span class="token value attr-value">SASL_PLAINTEXT</span></span>
<span class="line"><span class="token key attr-name">cluster2.efak.sasl.mechanism</span><span class="token punctuation">=</span><span class="token value attr-value">PLAIN</span></span>
<span class="line"><span class="token key attr-name">cluster2.efak.sasl.client.id</span><span class="token punctuation">=</span></span>
<span class="line"><span class="token key attr-name">cluster2.efak.blacklist.topics</span><span class="token punctuation">=</span></span>
<span class="line"><span class="token key attr-name">cluster2.efak.sasl.cgroup.enable</span><span class="token punctuation">=</span><span class="token value attr-value">false</span></span>
<span class="line"><span class="token key attr-name">cluster2.efak.sasl.cgroup.topics</span><span class="token punctuation">=</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">######################################</span></span>
<span class="line"><span class="token comment"># kafka ssl authenticate</span></span>
<span class="line"><span class="token comment">######################################</span></span>
<span class="line"><span class="token key attr-name">cluster3.efak.ssl.enable</span><span class="token punctuation">=</span><span class="token value attr-value">false</span></span>
<span class="line"><span class="token key attr-name">cluster3.efak.ssl.protocol</span><span class="token punctuation">=</span><span class="token value attr-value">SSL</span></span>
<span class="line"><span class="token key attr-name">cluster3.efak.ssl.truststore.location</span><span class="token punctuation">=</span></span>
<span class="line"><span class="token key attr-name">cluster3.efak.ssl.truststore.password</span><span class="token punctuation">=</span></span>
<span class="line"><span class="token key attr-name">cluster3.efak.ssl.keystore.location</span><span class="token punctuation">=</span></span>
<span class="line"><span class="token key attr-name">cluster3.efak.ssl.keystore.password</span><span class="token punctuation">=</span></span>
<span class="line"><span class="token key attr-name">cluster3.efak.ssl.key.password</span><span class="token punctuation">=</span></span>
<span class="line"><span class="token key attr-name">cluster3.efak.ssl.endpoint.identification.algorithm</span><span class="token punctuation">=</span><span class="token value attr-value">https</span></span>
<span class="line"><span class="token key attr-name">cluster3.efak.blacklist.topics</span><span class="token punctuation">=</span></span>
<span class="line"><span class="token key attr-name">cluster3.efak.ssl.cgroup.enable</span><span class="token punctuation">=</span><span class="token value attr-value">false</span></span>
<span class="line"><span class="token key attr-name">cluster3.efak.ssl.cgroup.topics</span><span class="token punctuation">=</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">######################################</span></span>
<span class="line"><span class="token comment"># kafka sqlite jdbc driver address</span></span>
<span class="line"><span class="token comment">######################################</span></span>
<span class="line"><span class="token comment">#efak.driver=org.sqlite.JDBC</span></span>
<span class="line"><span class="token comment">#efak.url=jdbc:sqlite:/hadoop/kafka-eagle/db/ke.db</span></span>
<span class="line"><span class="token comment">#efak.username=root</span></span>
<span class="line"><span class="token comment">#efak.password=www.kafka-eagle.org</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">######################################</span></span>
<span class="line"><span class="token comment"># kafka mysql jdbc driver address</span></span>
<span class="line"><span class="token comment">######################################</span></span>
<span class="line"><span class="token key attr-name">efak.driver</span><span class="token punctuation">=</span><span class="token value attr-value">com.mysql.cj.jdbc.Driver</span></span>
<span class="line"><span class="token key attr-name">efak.url</span><span class="token punctuation">=</span><span class="token value attr-value">jdbc:mysql://172.20.48.2:3306/ke?useUnicode=true&amp;characterEncoding=UTF-8&amp;zeroDateTimeBehavior=convertToNull</span></span>
<span class="line"><span class="token key attr-name">efak.username</span><span class="token punctuation">=</span><span class="token value attr-value">appcpa</span></span>
<span class="line"><span class="token key attr-name">efak.password</span><span class="token punctuation">=</span><span class="token value attr-value">appcpa</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>启动：</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line">ke.sh start    </span>
<span class="line">ke.sh stop    </span>
<span class="line">ke.sh restart    </span>
<span class="line">ke.sh status    </span>
<span class="line">ke.sh stats    </span>
<span class="line">ke.sh <span class="token function">find</span> <span class="token punctuation">[</span>ClassName<span class="token punctuation">]</span>    </span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></blockquote><h2 id="实践" tabindex="-1"><a class="header-anchor" href="#实践"><span>实践</span></a></h2><h3 id="磁盘迁移" tabindex="-1"><a class="header-anchor" href="#磁盘迁移"><span>磁盘迁移</span></a></h3><blockquote><p>背景介绍：Kafka搭建时，配置的磁盘过大，成本过高，所以需要迁移到小容量磁盘</p><p><strong>原kakfa配置：</strong></p><ul><li>log.dirs=/data1/kafka/var/kafka-logs/1,/data2/kafka/var/kafka-logs/1 <code>(kafka磁盘可以支持多磁盘配置，提高吞吐量)</code></li><li>log.retention.hours=168</li></ul><p><strong>修改后的kafka配置：</strong></p><ul><li>log.dirs=/data3/kafka-logs,/data4/kafka-logs</li><li>log.retention.hours=72</li></ul></blockquote><h4 id="_1-修改topic存储时间" tabindex="-1"><a class="header-anchor" href="#_1-修改topic存储时间"><span>1.修改topic存储时间</span></a></h4><blockquote><p>适量减少topic存储时间，可以加快迁移节奏，如果本身日志量不大，不超过100G，则没必要执行此步骤</p><p>并且可以预估出调整后的磁盘占用大小</p></blockquote><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token comment"># retention.ms=21600000 表示此设置topic 数据保存的时间，单位：毫秒，21600000 = 1000*60*60*6 = 6 小时</span></span>
<span class="line"><span class="token comment"># 线上可以提前写好 sh脚本，批量处理topic</span></span>
<span class="line"><span class="token function">sh</span> /home/hadoop/kafka_2.11-0.9.0.1/bin/kafka-configs.sh  <span class="token parameter variable">--zookeeper</span> <span class="token punctuation">{</span>zk配置地址<span class="token punctuation">}</span> <span class="token parameter variable">--alter</span> --add-config <span class="token string">&#39;retention.ms=21600000&#39;</span> --entity-type topics --entity-name <span class="token punctuation">{</span>topic_name<span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>观察<code>kafkaServer.out</code>日志，正常<code>broker</code>每5分钟触发一次删除任务，等看到日志中出现 <code>...delete...</code>日志，并且观察磁盘文件大小，已经变成预估空间大小，则说明已经删除完成</p></blockquote><h4 id="_2-停止kafka服务" tabindex="-1"><a class="header-anchor" href="#_2-停止kafka服务"><span>2.停止kafka服务</span></a></h4><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line">./bin/kafka-server-stop.sh stop</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>观察日志，出现 <code>shutdown complete</code>字样的日志时，并且使用 <code>jps -m</code> 命令，找不到kafka的进程之后，表示停止完成</p><h4 id="_3-执行数据拷贝" tabindex="-1"><a class="header-anchor" href="#_3-执行数据拷贝"><span>3.执行数据拷贝</span></a></h4><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /data3/kafka-logs</span>
<span class="line"><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /data4/kafka-logs</span>
<span class="line"><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /home/hadoop/kafka_2.11-0.9.0.1/logs</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 注意使用异步拷贝，防止当前shell窗口过期</span></span>
<span class="line"><span class="token function">nohup</span> <span class="token function">cp</span> <span class="token parameter variable">-r</span> /data1/kafka/var/kafka-logs/1/* /data3/kafka-logs/ <span class="token operator">&amp;</span></span>
<span class="line"><span class="token function">nohup</span> <span class="token function">cp</span> <span class="token parameter variable">-r</span> /data2/kafka/var/kafka-logs/1/* /data4/kafka-logs/ <span class="token operator">&amp;</span></span>
<span class="line"><span class="token comment"># 后续可以使用此命令，查看是否拷贝完成</span></span>
<span class="line"><span class="token function">ps</span> <span class="token parameter variable">-ef</span> <span class="token operator">|</span> <span class="token function">grep</span> kafka-logs</span>
<span class="line"><span class="token function">df</span> <span class="token parameter variable">-h</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>当观察到 新旧磁盘空间大小一致，且 <code>ps -ef | grep kafka-logs</code> 没有进程之后，说明拷贝完成</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token comment"># 拷贝完成后，修改原目录名称</span></span>
<span class="line"><span class="token function">mv</span> /data1/kafka /data1/kafka_bak</span>
<span class="line"><span class="token function">mv</span> /data2/kafka /data2/kafka_bak</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_4-修改配置" tabindex="-1"><a class="header-anchor" href="#_4-修改配置"><span>4.修改配置</span></a></h4><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token comment"># 修改kafka 配置文件</span></span>
<span class="line"><span class="token function">vim</span> /home/hadoop/kafka_2.11-0.9.0.1/config/server.properties</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 找到下面配置，并更改</span></span>
<span class="line"><span class="token assign-left variable">log.dirs</span><span class="token operator">=</span>/data3/kafka-logs,/data4/kafka-logs</span>
<span class="line"><span class="token assign-left variable">log.retention.hours</span><span class="token operator">=</span><span class="token number">72</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 修改gc日志配置，默认的会一直打印gc日志</span></span>
<span class="line"><span class="token function">vim</span> /home/hadoop/kafka_2.11-0.9.0.1/bin/kafka-run-class.sh</span>
<span class="line"><span class="token comment"># 找到下面配置，并更改</span></span>
<span class="line"><span class="token assign-left variable">KAFKA_GC_LOG_OPTS</span><span class="token operator">=</span><span class="token string">&quot; &quot;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_5-启动kafka服务" tabindex="-1"><a class="header-anchor" href="#_5-启动kafka服务"><span>5.启动kafka服务</span></a></h4><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line">./bin/kafka-server-start.sh <span class="token parameter variable">-daemon</span> config/server.properties</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 观察日志：查看到启动完成，并且 集群中没有未同步副本时，说明此kafka已经完全启动</span></span>
<span class="line"><span class="token function">tail</span> <span class="token parameter variable">-f</span> ./logs/kafkaServer.out</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 观察旧的磁盘目录下，没有新文件产生，说明迁移成功</span></span>
<span class="line"><span class="token function">ls</span> <span class="token parameter variable">-lrth</span> /data1</span>
<span class="line"><span class="token function">ls</span> <span class="token parameter variable">-lrth</span> /data2</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_6-恢复topic存储时间" tabindex="-1"><a class="header-anchor" href="#_6-恢复topic存储时间"><span>6.恢复topic存储时间</span></a></h4><blockquote><p>千万不要忘了这一步。。。</p></blockquote><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token function">sh</span> ./bin/kafka-configs.sh  <span class="token parameter variable">--zookeeper</span> <span class="token punctuation">{</span>zk配置地址<span class="token punctuation">}</span> <span class="token parameter variable">--alter</span> --delete-config <span class="token string">&#39;retention.ms&#39;</span> --entity-type topics --entity-name <span class="token punctuation">{</span>topic_name<span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h4 id="备注" tabindex="-1"><a class="header-anchor" href="#备注"><span>备注:</span></a></h4><ul><li>为什么要拷贝磁盘文件，而不是直接修改配置，重启kafka？ <ul><li>如果新的broker启动，加入集群，需要同步topic的数据；同步过程中，会占满带宽或磁盘IO，如果数据量过大，同步时间过长，会造成kakfa长时间不可用，线上数据淤积，影响业务</li><li>kakfa会在数据磁盘下生成：<code>recovery-point-offset-checkpoint</code>，<code>replication-offset-checkpoint</code>这俩文件，会记录当前磁盘下topic数据存储offset信息，拷贝过去之后会根据这俩文件同步数据，不会造成数据错乱问题</li><li>所以拷贝磁盘数据在数据量较大时，会是较优的方案</li></ul></li></ul></div><!--[--><!--]--></div><footer class="vp-page-meta"><!----><div class="vp-meta-item git-info"><div class="vp-meta-item last-updated"><span class="meta-item-label">Last Updated: </span><!----></div><div class="vp-meta-item contributors"><span class="meta-item-label">Contributors: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: lip.app@qq.com">peng.li</span><!----><!--]--><!--]--></span></div></div></footer><!----><!--[--><!--]--></main><!--]--></div><!--[--><!----><!--]--><!--]--></div>
    <script type="module" src="/blog/assets/app-B6K0T__V.js" defer></script>
  </body>
</html>
