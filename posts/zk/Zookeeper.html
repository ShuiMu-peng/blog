<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.18" />
    <style>
      :root {
        --vp-c-bg: #fff;
      }

      [data-theme='dark'] {
        --vp-c-bg: #1b1b1f;
      }

      html,
      body {
        background-color: var(--vp-c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme')
      const systemDarkMode =
        'matchMedia' in window
          ? window.matchMedia('(prefers-color-scheme: dark)').matches
          : false

      if (userMode === 'light') {
        document.documentElement.dataset.theme = 'light'
      } else if (userMode === 'dark' || systemDarkMode) {
        document.documentElement.dataset.theme = 'dark'
      }
    </script>
    <title>zookeeper | 水木</title><meta name="description" content="欢迎来到我的空间。">
    <link rel="preload" href="/blog/assets/style-BraDacIo.css" as="style"><link rel="stylesheet" href="/blog/assets/style-BraDacIo.css">
    <link rel="modulepreload" href="/blog/assets/app-B6K0T__V.js"><link rel="modulepreload" href="/blog/assets/Zookeeper.html-E7k0hsdB.js">
    <link rel="prefetch" href="/blog/assets/index.html-DVWxlgcq.js" as="script"><link rel="prefetch" href="/blog/assets/kafka.html-DOKItB-c.js" as="script"><link rel="prefetch" href="/blog/assets/scheduler.html-Drp__yoa.js" as="script"><link rel="prefetch" href="/blog/assets/Hbase.html-DvZ58706.js" as="script"><link rel="prefetch" href="/blog/assets/flink-to-clickHouse.html-DBxdG-y6.js" as="script"><link rel="prefetch" href="/blog/assets/ES.html-B-0MHbOn.js" as="script"><link rel="prefetch" href="/blog/assets/Rocket.html-_nH3SeUB.js" as="script"><link rel="prefetch" href="/blog/assets/mysql.html-CtUzXauf.js" as="script"><link rel="prefetch" href="/blog/assets/Redisson.html-Bx6FAVFm.js" as="script"><link rel="prefetch" href="/blog/assets/redis.html-CmvfnVrM.js" as="script"><link rel="prefetch" href="/blog/assets/404.html-D3ew3pPH.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-C-TNVO7u.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-DJkMpyD6.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-DZlQ2OIp.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-BEyGzpjh.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-CHIkBikE.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-Bio7xUaL.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-CmcSPK7G.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-BlebrQak.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-BNc27vfx.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-Ecd0iGwe.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-DWlVt83P.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-aJVo2Oli.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-0GHc2cMg.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-udISkAL3.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-uTUzK7xS.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-BJr_NcJc.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-KgIT-O3n.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-DkPTyIOo.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-x1GFYEdj.js" as="script"><link rel="prefetch" href="/blog/assets/setupDevtools-7MC2TMWH-hcQrRGMC.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><div class="vp-theme-container external-link-icon" vp-container><!--[--><header class="vp-navbar" vp-navbar><div class="vp-toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a class="route-link" href="/blog/"><img class="vp-site-logo" src="/blog/logo.jpg" alt="水木"><span class="vp-site-name vp-hide-mobile" aria-hidden="true">水木</span></a></span><div class="vp-navbar-items-wrapper" style=""><!--[--><!--]--><nav class="vp-navbar-items vp-hide-mobile" aria-label="site navigation"><!--[--><div class="vp-navbar-item"><a class="route-link auto-link" href="/blog/" aria-label="首页"><!---->首页<!----></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/blog/article/" aria-label="文章"><!---->文章<!----></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/blog/tag/" aria-label="标签"><!---->标签<!----></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/blog/category/" aria-label="分类"><!---->分类<!----></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/blog/timeline/" aria-label="时间线"><!---->时间线<!----></a></div><!--]--></nav><!--[--><!--]--><button type="button" class="vp-toggle-color-mode-button" title="toggle color mode"><svg class="light-icon" viewbox="0 0 32 32" style=""><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg class="dark-icon" viewbox="0 0 32 32" style="display:none;"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!----></div></header><!--]--><div class="vp-sidebar-mask"></div><!--[--><aside class="vp-sidebar" vp-sidebar><nav class="vp-navbar-items" aria-label="site navigation"><!--[--><div class="vp-navbar-item"><a class="route-link auto-link" href="/blog/" aria-label="首页"><!---->首页<!----></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/blog/article/" aria-label="文章"><!---->文章<!----></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/blog/tag/" aria-label="标签"><!---->标签<!----></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/blog/category/" aria-label="分类"><!---->分类<!----></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/blog/timeline/" aria-label="时间线"><!---->时间线<!----></a></div><!--]--></nav><!--[--><!--]--><ul class="vp-sidebar-items"><!--[--><li><p tabindex="0" class="vp-sidebar-item vp-sidebar-heading">zookeeper <!----></p><!----></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="vp-page"><!--[--><!--]--><div class="theme-default-content" vp-content><!--[--><!--]--><div><h2 id="zookeeper" tabindex="-1"><a class="header-anchor" href="#zookeeper"><span>Zookeeper</span></a></h2><blockquote><p>官网地址：https://zookeeper.apache.org/</p></blockquote><p>ZooKeeper本质上是一个分布式的小文件存储系统（Zookeeper=文件系统+监听机制）。提供基于类似于文件系统的目录树方式的数据存储，并且可以对树中的节点进行有效管理，从而用来维护和监控存储的数据的状态变化。通过监控这些数据状态的变化，从而可以达到基于数据的集群管理、统一命名服务、分布式配置管理、分布式消息队列、分布式锁、分布式协调等功能。</p><blockquote><p>Zookeeper从设计模式角度来理解：是一个基于观察者模式设计的分布式服务管理框架，它负责存储和管理大家都关心的数据，然后接受观察者的注册，一旦这些数据的状态发生变化，Zookeeper 就将负责通知已经在Zookeeper上注册的那些观察者做出相应的反应。</p></blockquote><h3 id="维护部署" tabindex="-1"><a class="header-anchor" href="#维护部署"><span>维护部署：</span></a></h3><h4 id="配置文件" tabindex="-1"><a class="header-anchor" href="#配置文件"><span>配置文件</span></a></h4><blockquote><p>zoo.cfg</p></blockquote><div class="language-properties line-numbers-mode" data-highlighter="prismjs" data-ext="properties" data-title="properties"><pre><code><span class="line"><span class="token comment"># The number of milliseconds of each tick</span></span>
<span class="line"><span class="token key attr-name">tickTime</span><span class="token punctuation">=</span><span class="token value attr-value">2000</span></span>
<span class="line"><span class="token comment"># The number of ticks that the initial</span></span>
<span class="line"><span class="token comment"># synchronization phase can take</span></span>
<span class="line"><span class="token key attr-name">initLimit</span><span class="token punctuation">=</span><span class="token value attr-value">10</span></span>
<span class="line"><span class="token comment"># The number of ticks that can pass between</span></span>
<span class="line"><span class="token key attr-name">syncLimit</span><span class="token punctuation">=</span><span class="token value attr-value">5</span></span>
<span class="line"><span class="token comment"># 数据存储地址，同时还会存储 Myid文件</span></span>
<span class="line"><span class="token key attr-name">dataDir</span><span class="token punctuation">=</span><span class="token value attr-value">/Users/lipeng/tool/zk/apache-zookeeper-3.6.3-bin/data</span></span>
<span class="line"><span class="token comment"># the port at which the clients will connect</span></span>
<span class="line"><span class="token key attr-name">clientPort</span><span class="token punctuation">=</span><span class="token value attr-value">2181</span></span>
<span class="line"><span class="token comment"># the maximum number of client connections.</span></span>
<span class="line"><span class="token comment"># 最大客户端连接数，-1 表示无限制</span></span>
<span class="line"><span class="token key attr-name">maxClientCnxns</span><span class="token punctuation">=</span><span class="token value attr-value">60</span></span>
<span class="line"><span class="token comment"># 集群配置，server.{id}={ip}:{port1}:{port2}</span></span>
<span class="line"><span class="token comment"># {id} 需要跟myid文件中的值相同；{ip} 节点的 ip地址，{port1} 数据交互 {port2} 选举投票端口</span></span>
<span class="line"><span class="token key attr-name">server.1</span><span class="token punctuation">=</span><span class="token value attr-value">192.168.1.2:2888:3888</span></span>
<span class="line"><span class="token key attr-name">server.2</span><span class="token punctuation">=</span><span class="token value attr-value">192.168.1.2:2889:3889</span></span>
<span class="line"><span class="token key attr-name">server.3</span><span class="token punctuation">=</span><span class="token value attr-value">192.168.1.2:2890:3890</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="服务启停" tabindex="-1"><a class="header-anchor" href="#服务启停"><span>服务启停</span></a></h4><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token comment"># 启动服务端</span></span>
<span class="line">./bin/zkServer.sh start</span>
<span class="line"><span class="token comment"># 查看机器状态</span></span>
<span class="line">./bin/zkServer.sh status</span>
<span class="line"><span class="token comment"># 停止服务</span></span>
<span class="line">./bin/zkServer.sh stop</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="客户端命令" tabindex="-1"><a class="header-anchor" href="#客户端命令"><span>客户端命令</span></a></h4><blockquote><p>https://zookeeper.apache.org/doc/r3.8.0/zookeeperCLI.html，支持的客户端操作</p></blockquote><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token comment"># 查看支持的命令</span></span>
<span class="line"><span class="token builtin class-name">help</span></span>
<span class="line"><span class="token comment"># 使用 ls 命令来查看当前 znode 的子节点，可监听</span></span>
<span class="line"><span class="token comment"># -s 状态（时间戳、版本号、数据大小等)</span></span>
<span class="line"><span class="token comment"># -w 监听子节点变化</span></span>
<span class="line"><span class="token comment"># -R: 表示递归的获取</span></span>
<span class="line"><span class="token function">ls</span> <span class="token punctuation">[</span>-s<span class="token punctuation">]</span> <span class="token punctuation">[</span>-w<span class="token punctuation">]</span> <span class="token punctuation">[</span>-R<span class="token punctuation">]</span> path</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 创建节点</span></span>
<span class="line"><span class="token comment"># -s : 创建有序节点。</span></span>
<span class="line"><span class="token comment"># -e : 创建临时节点。</span></span>
<span class="line"><span class="token comment"># -c : 创建一个容器节点。</span></span>
<span class="line"><span class="token comment"># t ttl] : 创建一个TTL节点， -t 时间（单位毫秒）。</span></span>
<span class="line"><span class="token comment"># data：节点的数据，可选，如果不使用时，节点数据就为null。</span></span>
<span class="line"><span class="token comment"># acl：访问控制</span></span>
<span class="line">create <span class="token punctuation">[</span>-s<span class="token punctuation">]</span> <span class="token punctuation">[</span>-e<span class="token punctuation">]</span> <span class="token punctuation">[</span>-c<span class="token punctuation">]</span> <span class="token punctuation">[</span>-t ttl<span class="token punctuation">]</span> path <span class="token punctuation">[</span>data<span class="token punctuation">]</span> <span class="token punctuation">[</span>acl<span class="token punctuation">]</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 获取节点数据信息</span></span>
<span class="line"><span class="token comment"># -s: 节点状态信息（时间戳、版本号、数据大小等）</span></span>
<span class="line"><span class="token comment"># -w: 监听节点变化</span></span>
<span class="line">get <span class="token punctuation">[</span>-s<span class="token punctuation">]</span> <span class="token punctuation">[</span>-w<span class="token punctuation">]</span> path</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 设置节点数据</span></span>
<span class="line"><span class="token comment"># -s:表示节点为顺序节点</span></span>
<span class="line"><span class="token comment"># -v: 指定版本号</span></span>
<span class="line"><span class="token builtin class-name">set</span> <span class="token punctuation">[</span>-s<span class="token punctuation">]</span> <span class="token punctuation">[</span>-v version<span class="token punctuation">]</span> path data</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 获取节点的访问控制信息</span></span>
<span class="line"><span class="token comment"># -s 状态（时间戳、版本号、数据大小等)</span></span>
<span class="line">getAcl <span class="token punctuation">[</span>-s<span class="token punctuation">]</span> path</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 设置节点的访问控制列表</span></span>
<span class="line"><span class="token comment"># -s:节点状态信息（时间戳、版本号、数据大小等）</span></span>
<span class="line"><span class="token comment"># -v:指定版本号</span></span>
<span class="line"><span class="token comment"># -R:递归的设置</span></span>
<span class="line">setAcl <span class="token punctuation">[</span>-s<span class="token punctuation">]</span> <span class="token punctuation">[</span>-v version<span class="token punctuation">]</span> <span class="token punctuation">[</span>-R<span class="token punctuation">]</span> path acl</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 查看节点状态信息</span></span>
<span class="line"><span class="token function">stat</span> <span class="token punctuation">[</span>-w<span class="token punctuation">]</span> path</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 删除某一节点，只能删除无子节点的节点。</span></span>
<span class="line">delete <span class="token punctuation">[</span>-v version<span class="token punctuation">]</span> path</span>
<span class="line"></span>
<span class="line"><span class="token comment">#递归的删除某一节点及其子节点</span></span>
<span class="line">deleteall path</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 对节点增加限制</span></span>
<span class="line"><span class="token comment"># n:表示子节点的最大个数</span></span>
<span class="line"><span class="token comment"># b:数据值的最大长度，-1表示无限制</span></span>
<span class="line">setquota -n<span class="token operator">|</span>-b val path</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="数据结构" tabindex="-1"><a class="header-anchor" href="#数据结构"><span>数据结构</span></a></h3><blockquote><p>ZooKeeper 数据模型的结构与 Unix 文件系统很类似，整体上可以看作是一棵树，每个节点称做一个 ZNode。</p></blockquote><p><img src="/blog/Zookeeper.assets/img.png" alt="img_1.png"></p><p>ZooKeeper的数据模型是层次模型，层次模型常见于文件系统。层次模型和key-value模型是两种主流的数据模型。ZooKeeper使用文件系统模型主要基于以下两点考虑:</p><ol><li>文件系统的树形结构便于表达数据之间的层次关系</li><li>文件系统的树形结构便于为不同的应用分配独立的命名空间( namespace )</li></ol><p>ZooKeeper的层次模型称作Data Tree，Data Tree的每个节点叫作Znode。不同于文件系统，每个节点都可以保存数据，每一个 ZNode 默认能够存储 1MB 的数据，每个 ZNode 都可以通过其路径唯一标识，每个节点都有一个版本(version)，版本从0开始计数。</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DataTree</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">DataNode</span><span class="token punctuation">&gt;</span></span> nodes <span class="token operator">=</span></span>
<span class="line">            <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">DataNode</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">WatchManager</span> dataWatches <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WatchManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">WatchManager</span> childWatches <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WatchManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DataNode</span> <span class="token keyword">implements</span> <span class="token class-name">Record</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">byte</span> data<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">Long</span> acl<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">StatPersisted</span> stat<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> children <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span> </span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="节点分类" tabindex="-1"><a class="header-anchor" href="#节点分类"><span><strong>节点分类</strong></span></a></h4><p><strong>一个znode可以使持久性的，也可以是临时性的:</strong></p><ol><li>持久节点(PERSISTENT): 这样的znode在创建之后即使发生ZooKeeper集群宕机或者client宕机也不会丢失。</li><li>临时节点(EPHEMERAL ): client宕机或者client在指定的timeout时间内没有给ZooKeeper集群发消息，这样的znode就会消失。</li></ol><p><strong>如果上面两种znode具备顺序性，又有以下两种znode :</strong></p><ol start="3"><li>持久顺序节点(PERSISTENT_SEQUENTIAL): znode除了具备持久性znode的特点之外，znode的名字具备顺序性。</li><li>临时顺序节点(EPHEMERAL_SEQUENTIAL): znode除了具备临时性znode的特点之外，zorde的名字具备顺序性。</li></ol><p>zookeeper主要用到的是以上4种节点。</p><ol start="5"><li><p>Container节点 (3.5.3版本新增)：Container容器节点，当容器中没有任何子节点，该容器节点会被zk定期删除（定时任务默认60s 检查一次)。 和持久节点的区别是 ZK 服务端启动后，会有一个单独的线程去扫描，所有的容器节点，当发现容器节点的子节点数量为 0 时，会自动删除该节点。可以用于 leader 或者锁的场景中。</p></li><li><p>TTL节点: 带过期时间节点，默认禁用，需要在zoo.cfg中添加 extendedTypesEnabled=true 开启。 注意：ttl不能用于临时节点</p></li></ol><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token comment">#创建持久节点</span></span>
<span class="line">create /servers  xxx</span>
<span class="line"><span class="token comment">#创建临时节点</span></span>
<span class="line">create <span class="token parameter variable">-e</span> /servers/host  xxx</span>
<span class="line"><span class="token comment">#创建临时有序节点</span></span>
<span class="line">create <span class="token parameter variable">-e</span> <span class="token parameter variable">-s</span> /servers/host  xxx</span>
<span class="line"><span class="token comment">#创建容器节点</span></span>
<span class="line">create <span class="token parameter variable">-c</span> /container xxx</span>
<span class="line"><span class="token comment"># 创建ttl节点</span></span>
<span class="line">create <span class="token parameter variable">-t</span> <span class="token number">10</span> /ttl</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>节点状态信息</strong></p><p><img src="/blog/Zookeeper.assets/image-20230522215952151.png" alt="image-20230522215952151"></p><ul><li>cZxid：节点创建的事务id</li><li>ctime：节点创建的时间戳</li><li>mZxid：节点修改的事务id，每次对zNode的修改，都会更新mZxid <ul><li>对于zk来说，每次的变化都会产生一个唯一的事务id，zxid（ZooKeeper Transaction Id），通过zxid，可以确定更新操作的先后顺序。例如，如果zxid1小于zxid2，说明zxid1操作先于zxid2发生，zxid对于整个zk都是唯一的，即使操作的是不同的znode。</li></ul></li><li>mtime：节点修改的事件戳</li><li></li></ul><p>pZxid：表示该节点的子节点列表最后一次修改的事务ID，添加子节点或删除子节点就会影响子节点列表，但是修改子节点的数据内容则不影响该ID（注意: 只有子节点列表变更了才会变更pzxid，子节点内容变更不会影响pzxid）</p><ul><li>cversion：子节点的版本号。当znode的子节点有变化时，cversion 的值就会增加1</li><li>dataVersion：数据版本号，每次对节点进行set操作，dataVersion的值都会增加1（即使设置的是相同的数据），可有效避免了数据更新时出现的先后顺序问题。</li><li>ephemeralOwner：如果为临时节点，值为与临时节点绑定的session id，否则为0</li><li>dataLength：数据长度</li><li>numChildren：子节点个数，仅通知直接子节点个数</li></ul><h4 id="监听通知-watcher-机制" tabindex="-1"><a class="header-anchor" href="#监听通知-watcher-机制"><span><strong>监听通知（watcher）机制</strong></span></a></h4><ul><li>一个Watch事件是一个一次性的触发器，当被设置了Watch的数据发生了改变的时候，则服务器将这个改变发送给设置了Watch的客户端，以便通知它们。</li><li>Zookeeper采用了 Watcher机制实现数据的发布订阅功能，多个订阅者可同时监听某一特定主题对象，当该主题对象的自身状态发生变化时例如节点内容改变、节点下的子节点列表改变等，会实时、主动通知所有订阅者。</li><li>watcher机制事件上与观察者模式类似，也可看作是一种观察者模式在分布式场景下的实现方式。</li><li>Zookeeper中的watch机制，必须客户端先去服务端注册监听，这样事件发送才会触发监听，通知给客户端。</li></ul><h5 id="watcher的过程" tabindex="-1"><a class="header-anchor" href="#watcher的过程"><span>watcher的过程：</span></a></h5><ol><li>客户端向服务端注册watcher</li><li>服务端发生事件，触发watcher</li><li>客户端回调watcher得到触发事件情况</li></ol><h5 id="支持的事件类型" tabindex="-1"><a class="header-anchor" href="#支持的事件类型"><span>支持的事件类型：</span></a></h5><ul><li>None: 连接建立事件</li><li>NodeCreated： 节点创建</li><li>NodeDeleted： 节点删除</li><li>NodeDataChanged：节点数据变化</li><li>NodeChildrenChanged：子节点列表变化</li><li>DataWatchRemoved：节点监听被移除</li><li>ChildWatchRemoved：子节点监听被移除</li></ul><h5 id="特性" tabindex="-1"><a class="header-anchor" href="#特性"><span>特性：</span></a></h5><ul><li>一次性触发：watcher是一次性的，一旦被触发就会移除，再次使用时需要重新注册</li><li>客户端顺序回调：watcher回调是顺序串行执行的，只有回调后客户端才能看到最新的数据状态。一个watcher回调逻辑不应该太多，以免影响别的watcher执行</li><li>轻量级：WatchEvent是最小的通信单位，结构上只包含通知状态、事件类型和节点路径，并不会告诉数据节点变化前后的具体内容</li><li>时效性：watcher只有在当前session彻底失效时才会无效，若在session有效期内快速重连成功，则watcher依然存在，仍可接收到通知；</li></ul><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token comment">#监听节点数据的变化</span></span>
<span class="line">get <span class="token parameter variable">-w</span> path </span>
<span class="line"><span class="token function">stat</span> <span class="token parameter variable">-w</span> path</span>
<span class="line"><span class="token comment">#监听子节点增减的变化 </span></span>
<span class="line"><span class="token function">ls</span> <span class="token parameter variable">-w</span> path </span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ZAB协议：</p><ul><li>原子广播协议</li><li>崩溃恢复协议</li></ul></div><!--[--><!--]--></div><footer class="vp-page-meta"><!----><div class="vp-meta-item git-info"><div class="vp-meta-item last-updated"><span class="meta-item-label">Last Updated: </span><!----></div><div class="vp-meta-item contributors"><span class="meta-item-label">Contributors: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: lip.app@qq.com">peng.li</span><!----><!--]--><!--]--></span></div></div></footer><!----><!--[--><!--]--></main><!--]--></div><!--[--><!----><!--]--><!--]--></div>
    <script type="module" src="/blog/assets/app-B6K0T__V.js" defer></script>
  </body>
</html>
