<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-rc.14">
    <script>
      (function() {
        const userMode = localStorage.getItem('vuepress-reco-color-scheme') || 'auto';
        const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;

        if (userMode === 'dark' || (userMode === 'auto' && systemDarkMode)) {
          document.documentElement.classList.toggle('dark', true);
        }
      })();
    </script>
    <title>Kafka-Producer | Game</title><meta name="description" content="shuiMu's blog">
    <link rel="preload" href="/blog/assets/style-BtcQQSZj.css" as="style"><link rel="stylesheet" href="/blog/assets/style-BtcQQSZj.css">
    <link rel="modulepreload" href="/blog/assets/app-CE4jh6_n.js"><link rel="modulepreload" href="/blog/assets/kafka_product.html-CV7gz3gM.js">
    <link rel="prefetch" href="/blog/assets/timeline.html-CaXBltbQ.js" as="script"><link rel="prefetch" href="/blog/assets/posts.html-BKrGHjP3.js" as="script"><link rel="prefetch" href="/blog/assets/friendship-link.html-CdsHEDMS.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-Dm9nS9ie.js" as="script"><link rel="prefetch" href="/blog/assets/2.html-Bm0polY3.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-C2Mn1BP-.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-DERDT24X.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-CrG1dzfa.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-Dc1z1BH2.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-BM24I094.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-B8AD7eKS.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-h6WHglwW.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-DVbtmUtY.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-D_1cPCbM.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-Do0LRn8_.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-CTenOdsk.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-BDpE8o12.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-enVbGBRG.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-jaH8lnAx.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-BLJZ4OBc.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-DHZyGLpd.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-Ch8qqslw.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-DM_vCXyI.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-CcldYHV7.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-1YWC0ixo.js" as="script"><link rel="prefetch" href="/blog/assets/2.html-HvpRY8YB.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-BO9hvCZ4.js" as="script"><link rel="prefetch" href="/blog/assets/guanggaoguiyin.html-BfXdzP22.js" as="script"><link rel="prefetch" href="/blog/assets/Hbase.html-7hfLBHyA.js" as="script"><link rel="prefetch" href="/blog/assets/flink-to-clickHouse.html-B7qLCSvQ.js" as="script"><link rel="prefetch" href="/blog/assets/ES.html-Dk-gTmlv.js" as="script"><link rel="prefetch" href="/blog/assets/kafka_1.html-BYvkn0cQ.js" as="script"><link rel="prefetch" href="/blog/assets/kafka_consumer.html-CGG9k0A_.js" as="script"><link rel="prefetch" href="/blog/assets/kafka_disk_migration.html-BWdD5zYA.js" as="script"><link rel="prefetch" href="/blog/assets/Rocket.html-DFGcKrkc.js" as="script"><link rel="prefetch" href="/blog/assets/mysql.html-CSs-t0vk.js" as="script"><link rel="prefetch" href="/blog/assets/guide.html-D2D6GRot.js" as="script"><link rel="prefetch" href="/blog/assets/Redisson.html-BMEtQF8-.js" as="script"><link rel="prefetch" href="/blog/assets/redis.html-BlySM6Jv.js" as="script"><link rel="prefetch" href="/blog/assets/scheduler.html-D7HY7VKh.js" as="script"><link rel="prefetch" href="/blog/assets/sentinel_shiyong(1).html-tFpSgsgP.js" as="script"><link rel="prefetch" href="/blog/assets/sentinel_yuanmafenxi.html-D0uvTzlz.js" as="script"><link rel="prefetch" href="/blog/assets/mybatisPlus-clickHouse.html-BGPXhOmQ.js" as="script"><link rel="prefetch" href="/blog/assets/Zookeeper.html-DcUKSo1n.js" as="script"><link rel="prefetch" href="/blog/assets/404.html-CYILANgK.js" as="script"><link rel="prefetch" href="/blog/assets/Valine.min-Dm4Ijz6H.js" as="script"><link rel="prefetch" href="/blog/assets/giscus-aTimukGI-CKTvSCx2.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container series--no show-catalog"><header class="navbar-container not-open"><div class="navbar-inner"><div class="site-brand nav-item"><img class="logo" src="/blog/logo.png" alt="Game"><a href="/blog/" class="site-name can-hide">Game</a></div><div class="nav-item navbar-links-wrapper" style=""><div><form class="search-box" role="search"><input type="search" autocomplete="off" spellcheck="false" value><!----></form></div><nav class="navbar-links"><!--[--><div class="navbar-links__item"><a href="/blog/" class="link router-link-active" aria-label="Home"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->Home<!--]--></span></span><!--[--><!--]--></a></div><div class="navbar-links__item"><div class="dropdown-link"><button class="dropdown-link__title" type="button" aria-label="Categories"><span class="xicon-container left title"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->Categories<!--]--></span></span><span class="arrow down"></span></button><button class="dropdown-link--mobile__title" type="button" aria-label="Categories"><span class="title"><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->Categories<!--]--></span></span></span><span class="right arrow"></span></button><ul style="display:none;" class="dropdown-link__container"><!--[--><li class="dropdown-link__item"><a href="/blog/categories/jishu/1.html" class="link" aria-label="技术"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->技术<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/blog/categories/yewu/1.html" class="link" aria-label="业务"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->业务<!--]--></span></span><!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-links__item"><div class="dropdown-link"><button class="dropdown-link__title" type="button" aria-label="Tags"><span class="xicon-container left title"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->Tags<!--]--></span></span><span class="arrow down"></span></button><button class="dropdown-link--mobile__title" type="button" aria-label="Tags"><span class="title"><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->Tags<!--]--></span></span></span><span class="right arrow"></span></button><ul style="display:none;" class="dropdown-link__container"><!--[--><li class="dropdown-link__item"><a href="/blog/tags/sentinel/1.html" class="link" aria-label="sentinel"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->sentinel<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/blog/tags/guanggaojiance/1.html" class="link" aria-label="广告监测"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->广告监测<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/blog/tags/quartz/1.html" class="link" aria-label="quartz"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->quartz<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/blog/tags/dolphinScheduler/1.html" class="link" aria-label="dolphinScheduler"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->dolphinScheduler<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/blog/tags/xxl-job/1.html" class="link" aria-label="xxl-job"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->xxl-job<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/blog/tags/hbase/1.html" class="link" aria-label="hbase"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->hbase<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/blog/tags/mysql/1.html" class="link" aria-label="mysql"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->mysql<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/blog/tags/zookeeper/1.html" class="link" aria-label="zookeeper"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->zookeeper<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/blog/tags/flink/1.html" class="link" aria-label="flink"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->flink<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/blog/tags/clickHouse/1.html" class="link" aria-label="clickHouse"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->clickHouse<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/blog/tags/mq/1.html" class="link" aria-label="mq"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->mq<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/blog/tags/rocketmq/1.html" class="link" aria-label="rocketmq"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->rocketmq<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/blog/tags/mybatis-plus/1.html" class="link" aria-label="mybatis-plus"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->mybatis-plus<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/blog/tags/clickhouse/1.html" class="link" aria-label="clickhouse"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->clickhouse<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/blog/tags/Redis/1.html" class="link" aria-label="Redis"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->Redis<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/blog/tags/Redisson/1.html" class="link" aria-label="Redisson"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->Redisson<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/blog/tags/elasticSearch/1.html" class="link" aria-label="elasticSearch"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->elasticSearch<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/blog/tags/kafka/1.html" class="link" aria-label="kafka"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->kafka<!--]--></span></span><!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-links__item"><a href="/blog/timeline.html" class="link" aria-label="时间轴"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->时间轴<!--]--></span></span><!--[--><!--]--></a></div><!--]--></nav><span class="xicon-container btn-toggle-dark-mode btn--dark-mode"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 32 32" style="width:20px;height:20px;font-size:20px;color:;"><path d="M15 2h2v3h-2z" fill="currentColor"></path><path d="M27 15h3v2h-3z" fill="currentColor"></path><path d="M15 27h2v3h-2z" fill="currentColor"></path><path d="M2 15h3v2H2z" fill="currentColor"></path><path d="M5.45 6.884l1.414-1.415l2.121 2.122l-1.414 1.414z" fill="currentColor"></path><path d="M23 7.58l2.121-2.12l1.414 1.414l-2.121 2.121z" fill="currentColor"></path><path d="M23.002 24.416l1.415-1.414l2.12 2.122l-1.413 1.414z" fill="currentColor"></path><path d="M5.47 25.13L7.59 23L9 24.42l-2.12 2.12l-1.41-1.41z" fill="currentColor"></path><path d="M16 8a8 8 0 1 0 8 8a8 8 0 0 0-8-8zm0 14a6 6 0 0 1 0-12z" fill="currentColor"></path></svg></span><span class="xicon-container btn-toggle-menus"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 32 32" style="width:20px;height:20px;font-size:20px;color:;"><circle cx="16" cy="8" r="2" fill="currentColor"></circle><circle cx="16" cy="16" r="2" fill="currentColor"></circle><circle cx="16" cy="24" r="2" fill="currentColor"></circle></svg></span></div></div></header><!----><!----><!----><div class="theme-main" style=""><!----><!--[--><main class="page-container"><div class="page-content"><h1 class="page-title">Kafka-Producer</h1><div class="page-info"><span class="xicon-container left"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 32 32" class="xicon-icon" style="width:18px;height:18px;font-size:18px;color:;"><path d="M16 4a5 5 0 1 1-5 5a5 5 0 0 1 5-5m0-2a7 7 0 1 0 7 7a7 7 0 0 0-7-7z" fill="currentColor"></path><path d="M26 30h-2v-5a5 5 0 0 0-5-5h-6a5 5 0 0 0-5 5v5H6v-5a7 7 0 0 1 7-7h6a7 7 0 0 1 7 7z" fill="currentColor"></path></svg><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->shuiMu<!--]--></span></span><span class="xicon-container left"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 32 32" class="xicon-icon" style="width:18px;height:18px;font-size:18px;color:;"><path d="M26 4h-4V2h-2v2h-8V2h-2v2H6c-1.1 0-2 .9-2 2v20c0 1.1.9 2 2 2h20c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 22H6V12h20v14zm0-16H6V6h4v2h2V6h8v2h2V6h4v4z" fill="currentColor"></path></svg><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->2021-06-02<!--]--></span></span><span class="xicon-container left"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 32 32" class="xicon-icon" style="width:18px;height:18px;font-size:18px;color:;"><path d="M11.17 6l3.42 3.41l.58.59H28v16H4V6h7.17m0-2H4a2 2 0 0 0-2 2v20a2 2 0 0 0 2 2h24a2 2 0 0 0 2-2V10a2 2 0 0 0-2-2H16l-3.41-3.41A2 2 0 0 0 11.17 4z" fill="currentColor"></path></svg><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[--><!--[--><a href="/blog/categories/jishu/1.html" class="">技术</a><!--]--><!--]--></span></span><span class="xicon-container left"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 32 32" class="xicon-icon" style="width:18px;height:18px;font-size:18px;color:;"><path d="M10 14a4 4 0 1 1 4-4a4.005 4.005 0 0 1-4 4zm0-6a2 2 0 1 0 1.998 2.004A2.002 2.002 0 0 0 10 8z" fill="currentColor"></path><path d="M16.644 29.415L2.586 15.354A2 2 0 0 1 2 13.941V4a2 2 0 0 1 2-2h9.941a2 2 0 0 1 1.414.586l14.06 14.058a2 2 0 0 1 0 2.828l-9.943 9.943a2 2 0 0 1-2.829 0zM4 4v9.942L18.058 28L28 18.058L13.942 4z" fill="currentColor"></path></svg><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[--><!--[--><a href="/blog/tags/kafka/1.html" class="">kafka</a><!--]--><!--]--></span></span><!----></div><div class="theme-reco-md-content"><div><h3 id="producer" tabindex="-1"><a class="header-anchor" href="#producer"><span>producer</span></a></h3><h4 id="拦截器" tabindex="-1"><a class="header-anchor" href="#拦截器"><span>拦截器：</span></a></h4><blockquote><ul><li>onSend：分区路由选择之前，调用此方法</li><li>onAcknowledgement：callback方法之前</li><li>close：producer 客户端调用close之后</li><li>configure：可以拿到客户端的所有配置</li></ul><p>可以使用此方式，做一些值统一处理，或者日志信息打印等</p></blockquote><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre class="language-java"><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyProducerInterceptor</span> <span class="token keyword">implements</span> <span class="token class-name">ProducerInterceptor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">long</span> successCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">long</span> failCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 增加 value 前缀</span></span>
<span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">onSend</span><span class="token punctuation">(</span><span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> record<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">String</span> newValue <span class="token operator">=</span> <span class="token string">&quot;new-- &quot;</span> <span class="token operator">+</span> record<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>record<span class="token punctuation">.</span><span class="token function">topic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> record<span class="token punctuation">.</span><span class="token function">partition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> record<span class="token punctuation">.</span><span class="token function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> newValue<span class="token punctuation">,</span> record<span class="token punctuation">.</span><span class="token function">headers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onAcknowledgement</span><span class="token punctuation">(</span><span class="token class-name">RecordMetadata</span> metadata<span class="token punctuation">,</span> <span class="token class-name">Exception</span> exception<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">isNull</span><span class="token punctuation">(</span>exception<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;发送成功&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;发送失败&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token comment">// TODO: 2021/6/9  </span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">&gt;</span></span> configs<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 配置, 多个拦截器 逗号隔开，按顺序执行</span></span>
<span class="line">props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span><span class="token constant">INTERCEPTOR_CLASSES_CONFIG</span><span class="token punctuation">,</span> <span class="token class-name">MyProducerInterceptor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="消息路由" tabindex="-1"><a class="header-anchor" href="#消息路由"><span>消息路由：</span></a></h4><p>选择<code>partition</code>机制为：</p><ul><li>如果指定<code>partition</code>，直接使用</li><li>未指定<code>partition</code>，但指定了<code>key</code>,对<code>key 进行 hash（MurmurHash2）</code>,与总的分区数取模<code>%</code>，计算出<code>partition</code></li><li><code>partition</code> 和 <code>key</code>都未指定，轮询方式发送至可用分区</li></ul><blockquote><p>注意：如果key不为null，会选择所有分区中的某一个，如果key为null，会选择可用分区的某一个</p><p>参考：<code>org.apache.kafka.clients.producer.internals.DefaultPartitioner</code></p></blockquote><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre class="language-java"><code><span class="line"><span class="token comment">// org.apache.kafka.clients.producer.internals.DefaultPartitioner#partition</span></span>
<span class="line">        <span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">partition</span><span class="token punctuation">(</span><span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> record<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> serializedKey<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> serializedValue<span class="token punctuation">,</span> <span class="token class-name">Cluster</span> cluster<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">Integer</span> partition <span class="token operator">=</span> record<span class="token punctuation">.</span><span class="token function">partition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> partition <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span></span>
<span class="line">                partition <span class="token operator">:</span></span>
<span class="line">                partitioner<span class="token punctuation">.</span><span class="token function">partition</span><span class="token punctuation">(</span></span>
<span class="line">                        record<span class="token punctuation">.</span><span class="token function">topic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> record<span class="token punctuation">.</span><span class="token function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> serializedKey<span class="token punctuation">,</span> record<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> serializedValue<span class="token punctuation">,</span> cluster<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span class="token comment">// org.apache.kafka.clients.producer.internals.DefaultPartitioner#partition</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">partition</span><span class="token punctuation">(</span><span class="token class-name">String</span> topic<span class="token punctuation">,</span> <span class="token class-name">Object</span> key<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> keyBytes<span class="token punctuation">,</span> <span class="token class-name">Object</span> value<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> valueBytes<span class="token punctuation">,</span> <span class="token class-name">Cluster</span> cluster<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>keyBytes <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> stickyPartitionCache<span class="token punctuation">.</span><span class="token function">partition</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> cluster<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span> </span>
<span class="line">        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PartitionInfo</span><span class="token punctuation">&gt;</span></span> partitions <span class="token operator">=</span> cluster<span class="token punctuation">.</span><span class="token function">partitionsForTopic</span><span class="token punctuation">(</span>topic<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">int</span> numPartitions <span class="token operator">=</span> partitions<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">// hash the keyBytes to choose a partition</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token class-name">Utils</span><span class="token punctuation">.</span><span class="token function">toPositive</span><span class="token punctuation">(</span><span class="token class-name">Utils</span><span class="token punctuation">.</span><span class="token function">murmur2</span><span class="token punctuation">(</span>keyBytes<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">%</span> numPartitions<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span class="token comment">// org.apache.kafka.clients.producer.internals.StickyPartitionCache#nextPartition</span></span>
<span class="line">     <span class="token keyword">while</span> <span class="token punctuation">(</span>newPart <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> newPart<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>oldPart<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">         <span class="token class-name">Integer</span> random <span class="token operator">=</span> <span class="token class-name">Utils</span><span class="token punctuation">.</span><span class="token function">toPositive</span><span class="token punctuation">(</span><span class="token class-name">ThreadLocalRandom</span><span class="token punctuation">.</span><span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">         newPart <span class="token operator">=</span> availablePartitions<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>random <span class="token operator">%</span> availablePartitions<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">partition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">     <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="java客户端使用" tabindex="-1"><a class="header-anchor" href="#java客户端使用"><span>JAVA客户端使用：</span></a></h4><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre class="language-java"><code><span class="line">        <span class="token class-name">Properties</span> props <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span><span class="token constant">BOOTSTRAP_SERVERS_CONFIG</span><span class="token punctuation">,</span> <span class="token string">&quot;localhost:9092,localhost:9093,localhost:9094&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">         <span class="token comment">/*</span>
<span class="line">         发出消息持久化机制参数</span>
<span class="line">        （1）acks=0： 表示producer不需要等待任何broker确认收到消息的回复，就可以继续发送下一条消息。性能最高，但是最容易丢消息。</span>
<span class="line">        （2）acks=1： 至少要等待leader已经成功将数据写入本地log，但是不需要等待所有follower是否成功写入。就可以继续发送下一</span>
<span class="line">             条消息。这种情况下，如果follower没有成功备份数据，而此时leader又挂掉，则消息会丢失。</span>
<span class="line">        （3）acks=-1或all： 需要等待 min.insync.replicas(默认为1，推荐配置大于等于2) 这个参数配置的副本个数都成功写入日志，这种策略会保证</span>
<span class="line">            只要有一个备份存活就不会丢失数据。这是最强的数据保证。一般除非是金融级别，或跟钱打交道的场景才会使用这种配置。</span>
<span class="line">         */</span></span>
<span class="line">        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span><span class="token constant">ACKS_CONFIG</span><span class="token punctuation">,</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">// 发送失败会重试，默认重试间隔100ms，重试能保证消息发送的可靠性，但是也可能造成消息重复发送，比如网络抖动，所以需要在</span></span>
<span class="line">        <span class="token comment">// 接收者那边做好消息接收的幂等性处理</span></span>
<span class="line">        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span><span class="token constant">RETRIES_CONFIG</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//重试间隔设置</span></span>
<span class="line">        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span><span class="token constant">RETRY_BACKOFF_MS_CONFIG</span><span class="token punctuation">,</span> <span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//设置发送消息的本地缓冲区，如果设置了该缓冲区，消息会先发送到本地缓冲区，可以提高消息发送性能，默认值是33554432，即32MB</span></span>
<span class="line">        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span><span class="token constant">BUFFER_MEMORY_CONFIG</span><span class="token punctuation">,</span> <span class="token number">33554432</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">// kafka本地线程会从缓冲区取数据，批量发送到broker，</span></span>
<span class="line">        <span class="token comment">// 设置批量发送消息的大小，默认值是16384，即16kb，就是说一个batch满了16kb就发送出去</span></span>
<span class="line">        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span><span class="token constant">BATCH_SIZE_CONFIG</span><span class="token punctuation">,</span> <span class="token number">16384</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">// 默认值是0，意思就是消息必须立即被发送，但这样会影响性能</span></span>
<span class="line">        <span class="token comment">// 一般设置10毫秒左右，就是说这个消息发送完后会进入本地的一个batch，如果10毫秒内，这个batch满了16kb就会随batch一起被发送出去</span></span>
<span class="line">        <span class="token comment">// 如果10毫秒内，batch没满，那么也必须把消息发送出去，不能让消息的发送延迟时间太长</span></span>
<span class="line">        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span><span class="token constant">LINGER_MS_CONFIG</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//把发送的key从字符串序列化为字节数组</span></span>
<span class="line">        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span><span class="token constant">KEY_SERIALIZER_CLASS_CONFIG</span><span class="token punctuation">,</span> <span class="token class-name">StringSerializer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//把发送消息value从字符串序列化为字节数组</span></span>
<span class="line">        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span><span class="token constant">VALUE_SERIALIZER_CLASS_CONFIG</span><span class="token punctuation">,</span> <span class="token class-name">StringSerializer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span><span class="token constant">INTERCEPTOR_CLASSES_CONFIG</span><span class="token punctuation">,</span> <span class="token class-name">MyProducerInterceptor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">Producer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> producer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KafkaProducer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">int</span> msgNum <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">final</span> <span class="token class-name">CountDownLatch</span> countDownLatch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CountDownLatch</span><span class="token punctuation">(</span>msgNum<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> msgNum<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">//指定发送分区</span></span>
<span class="line">            <span class="token comment">// ProducerRecord&lt;String, String&gt; producerRecord = new ProducerRecord&lt;String, String&gt;(TOPIC_NAME</span></span>
<span class="line">            <span class="token comment">//         , 0, order.getOrderId().toString(), JSON.toJSONString(order));</span></span>
<span class="line">            <span class="token comment">//未指定发送分区，具体发送的分区计算公式：hash(key)%partitionNum</span></span>
<span class="line">            <span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> producerRecord <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token constant">TOPIC_NAME</span><span class="token punctuation">,</span> <span class="token string">&quot;hhh:&quot;</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">            <span class="token comment">//等待消息发送成功的同步阻塞方法</span></span>
<span class="line">            <span class="token comment">/*RecordMetadata metadata = producer.send(producerRecord).get();</span>
<span class="line">            System.out.println(&quot;同步方式发送消息结果：&quot; + &quot;topic-&quot; + metadata.topic() + &quot;|partition-&quot;</span>
<span class="line">                    + metadata.partition() + &quot;|offset-&quot; + metadata.offset());*/</span></span>
<span class="line"></span>
<span class="line">            <span class="token comment">//异步回调方式发送消息</span></span>
<span class="line">            producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>producerRecord<span class="token punctuation">,</span> <span class="token punctuation">(</span>metadata<span class="token punctuation">,</span> exception<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">if</span> <span class="token punctuation">(</span>exception <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                    <span class="token class-name">System</span><span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;发送消息失败：&quot;</span> <span class="token operator">+</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>exception<span class="token punctuation">.</span><span class="token function">getStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">                <span class="token keyword">if</span> <span class="token punctuation">(</span>metadata <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;异步方式发送消息结果：&quot;</span> <span class="token operator">+</span> <span class="token string">&quot;topic-&quot;</span> <span class="token operator">+</span> metadata<span class="token punctuation">.</span><span class="token function">topic</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;|partition-&quot;</span></span>
<span class="line">                            <span class="token operator">+</span> metadata<span class="token punctuation">.</span><span class="token function">partition</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;|offset-&quot;</span> <span class="token operator">+</span> metadata<span class="token punctuation">.</span><span class="token function">offset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">                countDownLatch<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        countDownLatch<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        producer<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="原理图" tabindex="-1"><a class="header-anchor" href="#原理图"><span>原理图：</span></a></h4><p><img src="/blog/kafka.assets/%E4%BC%81%E4%B8%9A%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_612a3d0d-2731-42a6-8c3d-1219647a3ab3.png" alt="企业微信截图_612a3d0d-2731-42a6-8c3d-1219647a3ab3"></p><ul><li><code>org.apache.kafka.clients.producer.internals.RecordAccumulator</code><ul><li>消息累加器，本地消息的缓存</li><li><code>ConcurrentMap&lt;TopicPartition, Deque&lt;ProducerBatch&gt;&gt; batches</code><ul><li>key：分区</li><li>value：双端队列，保存消息<code>ProducerBatch</code></li></ul></li><li>ProducerBatch：一批<code>ProducerRecord</code> ,默认 16kb</li></ul></li><li><code>org.apache.kafka.clients.producer.internals.Sender</code><ul><li><code>implements Runnable</code>异步线程，从<code>RecordAccumulator</code>中获取消息</li><li>封装成<code>clientRequest</code><ul><li>封装成<code>inFlightRequest</code>对象，缓存到到：<code>org.apache.kafka.clients.InFlightRequests#requests</code><ul><li>Map&lt;BrokerId，InFlightRequest&gt;</li></ul></li><li><code>selector.send(send)</code></li></ul></li></ul></li><li><code>org.apache.kafka.clients.InFlightRequests</code><ul><li>请求发出时缓存，收到响应 或者 检测到超时后，会进行清理</li><li><strong>作用：</strong><ul><li>控制每个broker节点，正在运行请求的个数，默认5,超过此个数，则循环阻塞，配置参数：<code>max.in.flight.requests.per.connection</code></li><li>同步集群元数据流程和正常发送消息类似，也是封装 <code>MetadataRequest</code>，并且缓存在此，<code>InFlightRequests</code>缓存中，可以找到压力最小的 <code>broker</code>节点，使用此节点来进行元数据的同步</li></ul></li></ul></li></ul><h4 id="元数据同步" tabindex="-1"><a class="header-anchor" href="#元数据同步"><span>元数据同步</span></a></h4><blockquote><p>客户端超过<code>metadata.max.age.ms</code>配置时间元数据没有更新，则会触发元数据同步</p><p>元数据是指 Kafka 集群的元数据，这些元数据具体记录了集群中有哪些主题，这些主题有哪些分区，每个分区的 leader副本分配在哪个节点上， follower 副本分配在哪些节点上，哪些副本在 AR ISR 等集合中，集群中有哪些节点，控制器节点又是哪一个等信息。</p></blockquote><h4 id="写入流程" tabindex="-1"><a class="header-anchor" href="#写入流程"><span>写入流程：</span></a></h4><ul><li><code>producer</code>从<code>zk</code>中找到<code>partition</code>的<code>leader</code>节点 <img src="/blog/kafka.assets/image-20210601090513559.png" alt="image-20210601090513559"></li><li>将消息发送至<code>leader</code>节点</li><li><code>leader</code>将消息写入本地log</li><li><code>follower</code>从 <code>leader pull</code>消息，写入本地后，向<code>leader</code>发送<code>Ack</code></li><li><code>leader</code>收到所有 <code>ISR</code> 中节点的<code>Ack</code>后，增加<code>HW(hign watemark)</code></li></ul><h4 id="hw和leo" tabindex="-1"><a class="header-anchor" href="#hw和leo"><span><code>HW</code>和<code>LEO</code></span></a></h4><p><code>HW</code>高水位，HighWatemark的缩写，取一个<code>partition</code>对应的<code>ISR中最小的LEO(log-end-offset)作为HW</code>,<code>consumer</code>最多只能消费到<code>HW</code>所在的位置</p><p>过程如下：</p><p><img src="/blog/kafka.assets/image-20210602090739069.png" alt="image-20210602090739069"></p><p>为什么这么设计？</p><ul><li>保证各个副本<code>可消费</code>数据一致性</li></ul><h4 id="问题" tabindex="-1"><a class="header-anchor" href="#问题"><span>问题：</span></a></h4><p><strong>producer 发送套路</strong></p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre class="language-java"><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">ApiKeys</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// producer 发送数据</span></span>
<span class="line">    <span class="token function">PRODUCE</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">&quot;Produce&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token comment">// 元数据请求</span></span>
<span class="line">    <span class="token function">METADATA</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">&quot;Metadata&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token comment">// consumer offset 提交</span></span>
<span class="line">    <span class="token function">OFFSET_COMMIT</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">&quot;OffsetCommit&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token comment">// consumer offset 获取</span></span>
<span class="line">    <span class="token function">OFFSET_FETCH</span><span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">,</span> <span class="token string">&quot;OffsetFetch&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token comment">// consumer 加入消费组</span></span>
<span class="line">    <span class="token function">JOIN_GROUP</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">,</span> <span class="token string">&quot;JoinGroup&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token comment">// consumer 心跳</span></span>
<span class="line">    <span class="token function">HEARTBEAT</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">,</span> <span class="token string">&quot;Heartbeat&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token comment">// 消费组离开 group</span></span>
<span class="line">    <span class="token function">LEAVE_GROUP</span><span class="token punctuation">(</span><span class="token number">13</span><span class="token punctuation">,</span> <span class="token string">&quot;LeaveGroup&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token comment">// 消费组 同步消费组内的分区方案</span></span>
<span class="line">    <span class="token function">SYNC_GROUP</span><span class="token punctuation">(</span><span class="token number">14</span><span class="token punctuation">,</span> <span class="token string">&quot;SyncGroup&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token comment">//...... more</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>producer Ack1，hw没有更新，能消费到么？</strong></p><ul><li>不能</li></ul><p><strong>metadata 更新时机：</strong></p><blockquote><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre class="language-java"><code><span class="line"><span class="token class-name">MetadataResponseData</span><span class="token punctuation">(</span>throttleTimeMs<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> </span>
<span class="line">brokers<span class="token operator">=</span><span class="token punctuation">[</span></span>
<span class="line"> <span class="token class-name">MetadataResponseBroker</span><span class="token punctuation">(</span>nodeId<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> host<span class="token operator">=</span>&#39;<span class="token number">172.30</span><span class="token number">.105</span><span class="token number">.131</span>&#39;<span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">9092</span><span class="token punctuation">,</span> rack<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">,</span> </span>
<span class="line"> <span class="token class-name">MetadataResponseBroker</span><span class="token punctuation">(</span>nodeId<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> host<span class="token operator">=</span>&#39;<span class="token number">172.30</span><span class="token number">.105</span><span class="token number">.131</span>&#39;<span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">9094</span><span class="token punctuation">,</span> rack<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">,</span> </span>
<span class="line"> <span class="token class-name">MetadataResponseBroker</span><span class="token punctuation">(</span>nodeId<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> host<span class="token operator">=</span>&#39;<span class="token number">172.30</span><span class="token number">.105</span><span class="token number">.131</span>&#39;<span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">9093</span><span class="token punctuation">,</span> rack<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">]</span><span class="token punctuation">,</span> </span>
<span class="line">clusterId<span class="token operator">=</span>&#39;<span class="token class-name">M8qSCCTbR1OV0FTd_rm_PA</span>&#39;<span class="token punctuation">,</span> controllerId<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> </span>
<span class="line">topics<span class="token operator">=</span><span class="token punctuation">[</span></span>
<span class="line"> <span class="token class-name">MetadataResponseTopic</span><span class="token punctuation">(</span>errorCode<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token char">&#39;test5&#39;</span><span class="token punctuation">,</span> isInternal<span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">,</span> </span>
<span class="line">                       partitions<span class="token operator">=</span><span class="token punctuation">[</span></span>
<span class="line">                         <span class="token class-name">MetadataResponsePartition</span><span class="token punctuation">(</span>errorCode<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> partitionIndex<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> leaderId<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> leaderEpoch<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> replicaNodes<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> isrNodes<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> offlineReplicas<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">                         <span class="token class-name">MetadataResponsePartition</span><span class="token punctuation">(</span>errorCode<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> partitionIndex<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> leaderId<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> leaderEpoch<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> replicaNodes<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> isrNodes<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> offlineReplicas<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> </span>
<span class="line">                         <span class="token class-name">MetadataResponsePartition</span><span class="token punctuation">(</span>errorCode<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> partitionIndex<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> leaderId<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> leaderEpoch<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> replicaNodes<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> isrNodes<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> offlineReplicas<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> </span>
<span class="line">topicAuthorizedOperations<span class="token operator">=</span><span class="token operator">-</span><span class="token number">2147483648</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">clusterAuthorizedOperations<span class="token operator">=</span><span class="token operator">-</span><span class="token number">2147483648</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></blockquote><ul><li><p><code>send</code> 方法时，强制等待更新一次</p><ul><li><p>设置<code>needUpdate</code> 为<code>true</code></p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre class="language-java"><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">awaitUpdate</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">int</span> lastVersion<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">long</span> maxWaitMs<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>maxWaitMs <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;Max time to wait for metadata updates should not be &lt; 0 milli seconds&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token keyword">long</span> begin <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">// metadata.fetch.timeout.ms 元数据更新等待最大时间</span></span>
<span class="line">  <span class="token keyword">long</span> remainingWaitMs <span class="token operator">=</span> maxWaitMs<span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">// 没有更新，则一直 wait</span></span>
<span class="line">  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>version <span class="token operator">&lt;=</span> lastVersion<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>remainingWaitMs <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span></span>
<span class="line">      <span class="token function">wait</span><span class="token punctuation">(</span>remainingWaitMs<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">long</span> elapsed <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> begin<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>elapsed <span class="token operator">&gt;=</span> maxWaitMs<span class="token punctuation">)</span></span>
<span class="line">      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TimeoutException</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to update metadata after &quot;</span> <span class="token operator">+</span> maxWaitMs <span class="token operator">+</span> <span class="token string">&quot; ms.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    remainingWaitMs <span class="token operator">=</span> maxWaitMs <span class="token operator">-</span> elapsed<span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// sender 更新成功后，调用此方法</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token class-name">Cluster</span> cluster<span class="token punctuation">,</span> <span class="token keyword">long</span> now<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">this</span><span class="token punctuation">.</span>needUpdate <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">this</span><span class="token punctuation">.</span>lastRefreshMs <span class="token operator">=</span> now<span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">this</span><span class="token punctuation">.</span>lastSuccessfulRefreshMs <span class="token operator">=</span> now<span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// version 变化</span></span>
<span class="line">  <span class="token keyword">this</span><span class="token punctuation">.</span>version <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Listener</span> listener<span class="token operator">:</span> listeners<span class="token punctuation">)</span></span>
<span class="line">    listener<span class="token punctuation">.</span><span class="token function">onMetadataUpdate</span><span class="token punctuation">(</span>cluster<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment">// Do this after notifying listeners as subscribed topics&#39; list can be changed by listeners</span></span>
<span class="line">  <span class="token keyword">this</span><span class="token punctuation">.</span>cluster <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>needMetadataForAllTopics <span class="token operator">?</span> <span class="token function">getClusterForCurrentTopics</span><span class="token punctuation">(</span>cluster<span class="token punctuation">)</span> <span class="token operator">:</span> cluster<span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">// 唤醒 wait 线程</span></span>
<span class="line">  <span class="token function">notifyAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Updated cluster metadata version {} to {}&quot;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>version<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>cluster<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul></li><li><p><code>sender</code>线程中，<code>long metadataTimeout = metadataUpdater.maybeUpdate(now);</code></p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre class="language-java"><code><span class="line"><span class="token annotation punctuation">@Override</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">maybeUpdate</span><span class="token punctuation">(</span><span class="token keyword">long</span> now<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token comment">// </span></span>
<span class="line">  <span class="token keyword">long</span> timeToNextMetadataUpdate <span class="token operator">=</span> metadata<span class="token punctuation">.</span><span class="token function">timeToNextUpdate</span><span class="token punctuation">(</span>now<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">// （上次没有可用Node的时间 + 重试间隔 - 当前时间）一般为负数</span></span>
<span class="line">  <span class="token keyword">long</span> timeToNextReconnectAttempt <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>lastNoNodeAvailableMs <span class="token operator">+</span> metadata<span class="token punctuation">.</span><span class="token function">refreshBackoff</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> now<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">// 是否存在已发送元数据更新请求，但没有返回结果？</span></span>
<span class="line">  <span class="token keyword">long</span> waitForMetadataFetch <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>metadataFetchInProgress <span class="token operator">?</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token constant">MAX_VALUE</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">// 取最大值</span></span>
<span class="line">  <span class="token keyword">long</span> metadataTimeout <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>timeToNextMetadataUpdate<span class="token punctuation">,</span> timeToNextReconnectAttempt<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">                                  waitForMetadataFetch<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">// 为0，执行可能更新方法</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>metadataTimeout <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 获取最空闲的节点</span></span>
<span class="line">    <span class="token class-name">Node</span> node <span class="token operator">=</span> <span class="token function">leastLoadedNode</span><span class="token punctuation">(</span>now<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">maybeUpdate</span><span class="token punctuation">(</span>now<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">return</span> metadataTimeout<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">long</span> <span class="token function">timeToNextUpdate</span><span class="token punctuation">(</span><span class="token keyword">long</span> nowMs<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token comment">// 强制更新？0: Math.max((上次更新时间 + 刷新元数据的间隔时间 - 当前时间),0)</span></span>
<span class="line">  <span class="token keyword">long</span> timeToExpire <span class="token operator">=</span> needUpdate <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>lastSuccessfulRefreshMs <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>metadataExpireMs <span class="token operator">-</span> nowMs<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">// （上次请求时间 + 重试间隔 - 当前时间）一般为负数</span></span>
<span class="line">  <span class="token keyword">long</span> timeToAllowUpdate <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lastRefreshMs <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>refreshBackoffMs <span class="token operator">-</span> nowMs<span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">return</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>timeToExpire<span class="token punctuation">,</span> timeToAllowUpdate<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token operator">-</span> `leastLoadedNode`：最空闲的节点</span>
<span class="line">  </span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">Node</span> <span class="token function">leastLoadedNode</span><span class="token punctuation">(</span><span class="token keyword">long</span> now<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Node</span><span class="token punctuation">&gt;</span></span> nodes <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>metadataUpdater<span class="token punctuation">.</span><span class="token function">fetchNodes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">int</span> inflight <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token constant">MAX_VALUE</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">Node</span> found <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">int</span> offset <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>randOffset<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span>nodes<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> nodes<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">int</span> idx <span class="token operator">=</span> <span class="token punctuation">(</span>offset <span class="token operator">+</span> i<span class="token punctuation">)</span> <span class="token operator">%</span> nodes<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token class-name">Node</span> node <span class="token operator">=</span> nodes<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">int</span> currInflight <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>inFlightRequests<span class="token punctuation">.</span><span class="token function">inFlightRequestCount</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span><span class="token function">idString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>currInflight <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>connectionStates<span class="token punctuation">.</span><span class="token function">isConnected</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span><span class="token function">idString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token comment">// if we find an established connection with no in-flight requests we can stop right away</span></span>
<span class="line">                <span class="token keyword">return</span> node<span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>connectionStates<span class="token punctuation">.</span><span class="token function">isBlackedOut</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span><span class="token function">idString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> now<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> currInflight <span class="token operator">&lt;</span> inflight<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token comment">// otherwise if this is the best we have found so far, record that</span></span>
<span class="line">                inflight <span class="token operator">=</span> currInflight<span class="token punctuation">;</span></span>
<span class="line">                found <span class="token operator">=</span> node<span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">return</span> found<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul></div></div><footer class="page-meta"><!----><div class="meta-item last-updated"><span class="xicon-container left meta-item-label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 32 32" class="xicon-icon" style="width:20px;height:20px;font-size:20px;color:;"><path d="M26 4h-4V2h-2v2h-8V2h-2v2H6c-1.1 0-2 .9-2 2v20c0 1.1.9 2 2 2h20c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 22H6V12h20v14zm0-16H6V6h4v2h2V6h8v2h2V6h4v4z" fill="currentColor"></path></svg><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->Last Updated 10/18/2024, 7:03:33 AM<!--]--></span></span></div></footer><!----><!----></div><div class="page-catalog-container"><h5 class="tip">ON THIS PAGE</h5><ul><!--[--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/jishu/kakfa/kafka_product.html#producer" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="producer"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->producer<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--]--></ul></div></main><!--]--></div></div><!--[--><!----><!----><!--]--><!--]--></div>
    <script type="module" src="/blog/assets/app-CE4jh6_n.js" defer></script>
  </body>
</html>
