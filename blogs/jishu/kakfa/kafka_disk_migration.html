<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-rc.14">
    <script>
      (function() {
        const userMode = localStorage.getItem('vuepress-reco-color-scheme') || 'auto';
        const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;

        if (userMode === 'dark' || (userMode === 'auto' && systemDarkMode)) {
          document.documentElement.classList.toggle('dark', true);
        }
      })();
    </script>
    <link rel="icon" href="/blog/avatar.png"><title>Kafka-磁盘迁移 | Game</title><meta name="description" content="shuiMu's blog">
    <link rel="preload" href="/blog/assets/style-BtcQQSZj.css" as="style"><link rel="stylesheet" href="/blog/assets/style-BtcQQSZj.css">
    <link rel="modulepreload" href="/blog/assets/app-CmsP-zbh.js"><link rel="modulepreload" href="/blog/assets/kafka_disk_migration.html-1DPIm5t-.js">
    <link rel="prefetch" href="/blog/assets/timeline.html-BhFiLRlE.js" as="script"><link rel="prefetch" href="/blog/assets/posts.html-IWqQLTQL.js" as="script"><link rel="prefetch" href="/blog/assets/friendship-link.html-KBdbhHIx.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-DeBY2fFH.js" as="script"><link rel="prefetch" href="/blog/assets/2.html-mK5llPSI.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-6i-dghJT.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-zAoBQLye.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-sIoQ_vq_.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-B42TLmoc.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-Wdqlg84h.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-BDOIrvcc.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-m2M6vp9D.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-B-RMiTvI.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-yMmOBHuX.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-D5F8NGEv.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-sM_uikiC.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-BV3ehGex.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-Ce-t3QMx.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-D_BCmCx5.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-DeSs_oN_.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-DlYpxmR6.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-B_7Yr_6S.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-DmYQRerB.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-BnE6GTls.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-CEqHt-Yl.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-DrjOi__9.js" as="script"><link rel="prefetch" href="/blog/assets/1.html-D3OwHrq_.js" as="script"><link rel="prefetch" href="/blog/assets/2.html-CWbLZI8g.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-CTBoTqbF.js" as="script"><link rel="prefetch" href="/blog/assets/guanggaoguiyin.html-CaRViyVV.js" as="script"><link rel="prefetch" href="/blog/assets/RAG（yi）xianglianghuacunchu Embedding.html-C2wgrDs9.js" as="script"><link rel="prefetch" href="/blog/assets/Hbase.html-C8yomZwN.js" as="script"><link rel="prefetch" href="/blog/assets/flink-to-clickHouse.html-MRINY2QT.js" as="script"><link rel="prefetch" href="/blog/assets/ES.html-DUpdNPR9.js" as="script"><link rel="prefetch" href="/blog/assets/kafka_1.html-BMtWvBjM.js" as="script"><link rel="prefetch" href="/blog/assets/kafka_consumer.html-YwTOuYAX.js" as="script"><link rel="prefetch" href="/blog/assets/kafka_product.html-CkkFRhPC.js" as="script"><link rel="prefetch" href="/blog/assets/RabbitMQ.html-CECn_P5J.js" as="script"><link rel="prefetch" href="/blog/assets/Rocket.html-abWQCpIi.js" as="script"><link rel="prefetch" href="/blog/assets/mysql.html-DaOyoT-c.js" as="script"><link rel="prefetch" href="/blog/assets/Redisson.html-SUHKsaJH.js" as="script"><link rel="prefetch" href="/blog/assets/redis.html-bEIVJaH4.js" as="script"><link rel="prefetch" href="/blog/assets/scheduler.html-BAohdl4A.js" as="script"><link rel="prefetch" href="/blog/assets/sentinel_shiyong(1).html-z7Z6B2gj.js" as="script"><link rel="prefetch" href="/blog/assets/sentinel_yuanmafenxi.html-DWqYUU33.js" as="script"><link rel="prefetch" href="/blog/assets/mybatisPlus-clickHouse.html-Cr5WERVN.js" as="script"><link rel="prefetch" href="/blog/assets/Zookeeper.html-B9e9gAHP.js" as="script"><link rel="prefetch" href="/blog/assets/404.html-yGBIk-4p.js" as="script"><link rel="prefetch" href="/blog/assets/Valine.min-Dm4Ijz6H.js" as="script"><link rel="prefetch" href="/blog/assets/giscus-aTimukGI-CKTvSCx2.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container series--no show-catalog"><header class="navbar-container not-open"><div class="navbar-inner"><div class="site-brand nav-item"><img class="logo" src="/blog/logo.png" alt="Game"><a href="/blog/" class="site-name can-hide">Game</a></div><div class="nav-item navbar-links-wrapper" style=""><div><form class="search-box" role="search"><input type="search" autocomplete="off" spellcheck="false" value><!----></form></div><nav class="navbar-links"><!--[--><div class="navbar-links__item"><a href="/blog/" class="link router-link-active" aria-label="Home"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->Home<!--]--></span></span><!--[--><!--]--></a></div><div class="navbar-links__item"><div class="dropdown-link"><button class="dropdown-link__title" type="button" aria-label="Categories"><span class="xicon-container left title"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->Categories<!--]--></span></span><span class="arrow down"></span></button><button class="dropdown-link--mobile__title" type="button" aria-label="Categories"><span class="title"><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->Categories<!--]--></span></span></span><span class="right arrow"></span></button><ul style="display:none;" class="dropdown-link__container"><!--[--><li class="dropdown-link__item"><a href="/blog/categories/jishu/1.html" class="link" aria-label="技术"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->技术<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/blog/categories/yewu/1.html" class="link" aria-label="业务"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->业务<!--]--></span></span><!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-links__item"><div class="dropdown-link"><button class="dropdown-link__title" type="button" aria-label="Tags"><span class="xicon-container left title"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->Tags<!--]--></span></span><span class="arrow down"></span></button><button class="dropdown-link--mobile__title" type="button" aria-label="Tags"><span class="title"><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->Tags<!--]--></span></span></span><span class="right arrow"></span></button><ul style="display:none;" class="dropdown-link__container"><!--[--><li class="dropdown-link__item"><a href="/blog/tags/ai/1.html" class="link" aria-label="ai"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->ai<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/blog/tags/sentinel/1.html" class="link" aria-label="sentinel"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->sentinel<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/blog/tags/guanggaojiance/1.html" class="link" aria-label="广告监测"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->广告监测<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/blog/tags/quartz/1.html" class="link" aria-label="quartz"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->quartz<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/blog/tags/dolphinScheduler/1.html" class="link" aria-label="dolphinScheduler"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->dolphinScheduler<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/blog/tags/xxl-job/1.html" class="link" aria-label="xxl-job"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->xxl-job<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/blog/tags/hbase/1.html" class="link" aria-label="hbase"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->hbase<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/blog/tags/mysql/1.html" class="link" aria-label="mysql"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->mysql<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/blog/tags/zookeeper/1.html" class="link" aria-label="zookeeper"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->zookeeper<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/blog/tags/flink/1.html" class="link" aria-label="flink"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->flink<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/blog/tags/clickHouse/1.html" class="link" aria-label="clickHouse"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->clickHouse<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/blog/tags/mq/1.html" class="link" aria-label="mq"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->mq<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/blog/tags/rocketmq/1.html" class="link" aria-label="rocketmq"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->rocketmq<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/blog/tags/mybatis-plus/1.html" class="link" aria-label="mybatis-plus"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->mybatis-plus<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/blog/tags/clickhouse/1.html" class="link" aria-label="clickhouse"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->clickhouse<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/blog/tags/Redis/1.html" class="link" aria-label="Redis"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->Redis<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/blog/tags/Redisson/1.html" class="link" aria-label="Redisson"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->Redisson<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/blog/tags/elasticSearch/1.html" class="link" aria-label="elasticSearch"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->elasticSearch<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/blog/tags/kafka/1.html" class="link" aria-label="kafka"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->kafka<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/blog/tags/RabbitMq/1.html" class="link" aria-label="RabbitMq"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->RabbitMq<!--]--></span></span><!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-links__item"><a href="/blog/timeline.html" class="link" aria-label="时间轴"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->时间轴<!--]--></span></span><!--[--><!--]--></a></div><!--]--></nav><span class="xicon-container btn-toggle-dark-mode btn--dark-mode"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 32 32" style="width:20px;height:20px;font-size:20px;color:;"><path d="M15 2h2v3h-2z" fill="currentColor"></path><path d="M27 15h3v2h-3z" fill="currentColor"></path><path d="M15 27h2v3h-2z" fill="currentColor"></path><path d="M2 15h3v2H2z" fill="currentColor"></path><path d="M5.45 6.884l1.414-1.415l2.121 2.122l-1.414 1.414z" fill="currentColor"></path><path d="M23 7.58l2.121-2.12l1.414 1.414l-2.121 2.121z" fill="currentColor"></path><path d="M23.002 24.416l1.415-1.414l2.12 2.122l-1.413 1.414z" fill="currentColor"></path><path d="M5.47 25.13L7.59 23L9 24.42l-2.12 2.12l-1.41-1.41z" fill="currentColor"></path><path d="M16 8a8 8 0 1 0 8 8a8 8 0 0 0-8-8zm0 14a6 6 0 0 1 0-12z" fill="currentColor"></path></svg></span><span class="xicon-container btn-toggle-menus"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 32 32" style="width:20px;height:20px;font-size:20px;color:;"><circle cx="16" cy="8" r="2" fill="currentColor"></circle><circle cx="16" cy="16" r="2" fill="currentColor"></circle><circle cx="16" cy="24" r="2" fill="currentColor"></circle></svg></span></div></div></header><!----><!----><!----><div class="theme-main" style=""><!----><!--[--><main class="page-container"><div class="page-content"><h1 class="page-title">Kafka-磁盘迁移</h1><div class="page-info"><span class="xicon-container left"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 32 32" class="xicon-icon" style="width:18px;height:18px;font-size:18px;color:;"><path d="M16 4a5 5 0 1 1-5 5a5 5 0 0 1 5-5m0-2a7 7 0 1 0 7 7a7 7 0 0 0-7-7z" fill="currentColor"></path><path d="M26 30h-2v-5a5 5 0 0 0-5-5h-6a5 5 0 0 0-5 5v5H6v-5a7 7 0 0 1 7-7h6a7 7 0 0 1 7 7z" fill="currentColor"></path></svg><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->shuiMu<!--]--></span></span><span class="xicon-container left"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 32 32" class="xicon-icon" style="width:18px;height:18px;font-size:18px;color:;"><path d="M26 4h-4V2h-2v2h-8V2h-2v2H6c-1.1 0-2 .9-2 2v20c0 1.1.9 2 2 2h20c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 22H6V12h20v14zm0-16H6V6h4v2h2V6h8v2h2V6h4v4z" fill="currentColor"></path></svg><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->2021-06-03<!--]--></span></span><span class="xicon-container left"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 32 32" class="xicon-icon" style="width:18px;height:18px;font-size:18px;color:;"><path d="M11.17 6l3.42 3.41l.58.59H28v16H4V6h7.17m0-2H4a2 2 0 0 0-2 2v20a2 2 0 0 0 2 2h24a2 2 0 0 0 2-2V10a2 2 0 0 0-2-2H16l-3.41-3.41A2 2 0 0 0 11.17 4z" fill="currentColor"></path></svg><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[--><!--[--><a href="/blog/categories/jishu/1.html" class="">技术</a><!--]--><!--]--></span></span><span class="xicon-container left"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 32 32" class="xicon-icon" style="width:18px;height:18px;font-size:18px;color:;"><path d="M10 14a4 4 0 1 1 4-4a4.005 4.005 0 0 1-4 4zm0-6a2 2 0 1 0 1.998 2.004A2.002 2.002 0 0 0 10 8z" fill="currentColor"></path><path d="M16.644 29.415L2.586 15.354A2 2 0 0 1 2 13.941V4a2 2 0 0 1 2-2h9.941a2 2 0 0 1 1.414.586l14.06 14.058a2 2 0 0 1 0 2.828l-9.943 9.943a2 2 0 0 1-2.829 0zM4 4v9.942L18.058 28L28 18.058L13.942 4z" fill="currentColor"></path></svg><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[--><!--[--><a href="/blog/tags/kafka/1.html" class="">kafka</a><!--]--><!--]--></span></span><!----></div><div class="theme-reco-md-content"><div><h3 id="磁盘迁移" tabindex="-1"><a class="header-anchor" href="#磁盘迁移"><span>磁盘迁移</span></a></h3><blockquote><p>背景介绍：Kafka搭建时，配置的磁盘过大，成本过高，所以需要迁移到小容量磁盘</p><p><strong>原kakfa配置：</strong></p><ul><li>log.dirs=/data1/kafka/var/kafka-logs/1,/data2/kafka/var/kafka-logs/1 <code>(kafka磁盘可以支持多磁盘配置，提高吞吐量)</code></li><li>log.retention.hours=168</li></ul><p><strong>修改后的kafka配置：</strong></p><ul><li>log.dirs=/data3/kafka-logs,/data4/kafka-logs</li><li>log.retention.hours=72</li></ul></blockquote><h4 id="_1-修改topic存储时间" tabindex="-1"><a class="header-anchor" href="#_1-修改topic存储时间"><span>1.修改topic存储时间</span></a></h4><blockquote><p>适量减少topic存储时间，可以加快迁移节奏，如果本身日志量不大，不超过100G，则没必要执行此步骤</p><p>并且可以预估出调整后的磁盘占用大小</p></blockquote><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="line"><span class="token comment"># retention.ms=21600000 表示此设置topic 数据保存的时间，单位：毫秒，21600000 = 1000*60*60*6 = 6 小时</span></span>
<span class="line"><span class="token comment"># 线上可以提前写好 sh脚本，批量处理topic</span></span>
<span class="line"><span class="token function">sh</span> /home/hadoop/kafka_2.11-0.9.0.1/bin/kafka-configs.sh  <span class="token parameter variable">--zookeeper</span> <span class="token punctuation">{</span>zk配置地址<span class="token punctuation">}</span> <span class="token parameter variable">--alter</span> --add-config <span class="token string">&#39;retention.ms=21600000&#39;</span> --entity-type topics --entity-name <span class="token punctuation">{</span>topic_name<span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>观察<code>kafkaServer.out</code>日志，正常<code>broker</code>每5分钟触发一次删除任务，等看到日志中出现 <code>...delete...</code>日志，并且观察磁盘文件大小，已经变成预估空间大小，则说明已经删除完成</p></blockquote><h4 id="_2-停止kafka服务" tabindex="-1"><a class="header-anchor" href="#_2-停止kafka服务"><span>2.停止kafka服务</span></a></h4><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="line">./bin/kafka-server-stop.sh stop</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>观察日志，出现 <code>shutdown complete</code>字样的日志时，并且使用 <code>jps -m</code> 命令，找不到kafka的进程之后，表示停止完成</p><h4 id="_3-执行数据拷贝" tabindex="-1"><a class="header-anchor" href="#_3-执行数据拷贝"><span>3.执行数据拷贝</span></a></h4><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="line"><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /data3/kafka-logs</span>
<span class="line"><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /data4/kafka-logs</span>
<span class="line"><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /home/hadoop/kafka_2.11-0.9.0.1/logs</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 注意使用异步拷贝，防止当前shell窗口过期</span></span>
<span class="line"><span class="token function">nohup</span> <span class="token function">cp</span> <span class="token parameter variable">-r</span> /data1/kafka/var/kafka-logs/1/* /data3/kafka-logs/ <span class="token operator">&amp;</span></span>
<span class="line"><span class="token function">nohup</span> <span class="token function">cp</span> <span class="token parameter variable">-r</span> /data2/kafka/var/kafka-logs/1/* /data4/kafka-logs/ <span class="token operator">&amp;</span></span>
<span class="line"><span class="token comment"># 后续可以使用此命令，查看是否拷贝完成</span></span>
<span class="line"><span class="token function">ps</span> <span class="token parameter variable">-ef</span> <span class="token operator">|</span> <span class="token function">grep</span> kafka-logs</span>
<span class="line"><span class="token function">df</span> <span class="token parameter variable">-h</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>当观察到 新旧磁盘空间大小一致，且 <code>ps -ef | grep kafka-logs</code> 没有进程之后，说明拷贝完成</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="line"><span class="token comment"># 拷贝完成后，修改原目录名称</span></span>
<span class="line"><span class="token function">mv</span> /data1/kafka /data1/kafka_bak</span>
<span class="line"><span class="token function">mv</span> /data2/kafka /data2/kafka_bak</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_4-修改配置" tabindex="-1"><a class="header-anchor" href="#_4-修改配置"><span>4.修改配置</span></a></h4><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="line"><span class="token comment"># 修改kafka 配置文件</span></span>
<span class="line"><span class="token function">vim</span> /home/hadoop/kafka_2.11-0.9.0.1/config/server.properties</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 找到下面配置，并更改</span></span>
<span class="line"><span class="token assign-left variable">log.dirs</span><span class="token operator">=</span>/data3/kafka-logs,/data4/kafka-logs</span>
<span class="line"><span class="token assign-left variable">log.retention.hours</span><span class="token operator">=</span><span class="token number">72</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 修改gc日志配置，默认的会一直打印gc日志</span></span>
<span class="line"><span class="token function">vim</span> /home/hadoop/kafka_2.11-0.9.0.1/bin/kafka-run-class.sh</span>
<span class="line"><span class="token comment"># 找到下面配置，并更改</span></span>
<span class="line"><span class="token assign-left variable">KAFKA_GC_LOG_OPTS</span><span class="token operator">=</span><span class="token string">&quot; &quot;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_5-启动kafka服务" tabindex="-1"><a class="header-anchor" href="#_5-启动kafka服务"><span>5.启动kafka服务</span></a></h4><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="line">./bin/kafka-server-start.sh <span class="token parameter variable">-daemon</span> config/server.properties</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 观察日志：查看到启动完成，并且 集群中没有未同步副本时，说明此kafka已经完全启动</span></span>
<span class="line"><span class="token function">tail</span> <span class="token parameter variable">-f</span> ./logs/kafkaServer.out</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 观察旧的磁盘目录下，没有新文件产生，说明迁移成功</span></span>
<span class="line"><span class="token function">ls</span> <span class="token parameter variable">-lrth</span> /data1</span>
<span class="line"><span class="token function">ls</span> <span class="token parameter variable">-lrth</span> /data2</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_6-恢复topic存储时间" tabindex="-1"><a class="header-anchor" href="#_6-恢复topic存储时间"><span>6.恢复topic存储时间</span></a></h4><blockquote><p>千万不要忘了这一步。。。</p></blockquote><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="line"><span class="token function">sh</span> ./bin/kafka-configs.sh  <span class="token parameter variable">--zookeeper</span> <span class="token punctuation">{</span>zk配置地址<span class="token punctuation">}</span> <span class="token parameter variable">--alter</span> --delete-config <span class="token string">&#39;retention.ms&#39;</span> --entity-type topics --entity-name <span class="token punctuation">{</span>topic_name<span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h4 id="备注" tabindex="-1"><a class="header-anchor" href="#备注"><span>备注:</span></a></h4><ul><li>为什么要拷贝磁盘文件，而不是直接修改配置，重启kafka？ <ul><li>如果新的broker启动，加入集群，需要同步topic的数据；同步过程中，会占满带宽或磁盘IO，如果数据量过大，同步时间过长，会造成kakfa长时间不可用，线上数据淤积，影响业务</li><li>kakfa会在数据磁盘下生成：<code>recovery-point-offset-checkpoint</code>，<code>replication-offset-checkpoint</code>这俩文件，会记录当前磁盘下topic数据存储offset信息，拷贝过去之后会根据这俩文件同步数据，不会造成数据错乱问题</li><li>所以拷贝磁盘数据在数据量较大时，会是较优的方案</li></ul></li></ul></div></div><footer class="page-meta"><!----><div class="meta-item last-updated"><span class="xicon-container left meta-item-label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 32 32" class="xicon-icon" style="width:20px;height:20px;font-size:20px;color:;"><path d="M26 4h-4V2h-2v2h-8V2h-2v2H6c-1.1 0-2 .9-2 2v20c0 1.1.9 2 2 2h20c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 22H6V12h20v14zm0-16H6V6h4v2h2V6h8v2h2V6h4v4z" fill="currentColor"></path></svg><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->更新时间 10/18/2024, 7:03:33 AM<!--]--></span></span></div></footer><!----><!----></div><div class="page-catalog-container"><h5 class="tip">ON THIS PAGE</h5><ul><!--[--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blog/blogs/jishu/kakfa/kafka_disk_migration.html#磁盘迁移" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="磁盘迁移"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->磁盘迁移<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--]--></ul></div></main><!--]--></div></div><!--[--><!----><!----><!--]--><!--]--></div>
    <script type="module" src="/blog/assets/app-CmsP-zbh.js" defer></script>
  </body>
</html>
