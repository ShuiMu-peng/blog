import{_ as s,c as n,e,o as l}from"./app-CE4jh6_n.js";const i={};function p(t,a){return l(),n("div",null,a[0]||(a[0]=[e(`<h3 id="磁盘迁移" tabindex="-1"><a class="header-anchor" href="#磁盘迁移"><span>磁盘迁移</span></a></h3><blockquote><p>背景介绍：Kafka搭建时，配置的磁盘过大，成本过高，所以需要迁移到小容量磁盘</p><p><strong>原kakfa配置：</strong></p><ul><li>log.dirs=/data1/kafka/var/kafka-logs/1,/data2/kafka/var/kafka-logs/1 <code>(kafka磁盘可以支持多磁盘配置，提高吞吐量)</code></li><li>log.retention.hours=168</li></ul><p><strong>修改后的kafka配置：</strong></p><ul><li>log.dirs=/data3/kafka-logs,/data4/kafka-logs</li><li>log.retention.hours=72</li></ul></blockquote><h4 id="_1-修改topic存储时间" tabindex="-1"><a class="header-anchor" href="#_1-修改topic存储时间"><span>1.修改topic存储时间</span></a></h4><blockquote><p>适量减少topic存储时间，可以加快迁移节奏，如果本身日志量不大，不超过100G，则没必要执行此步骤</p><p>并且可以预估出调整后的磁盘占用大小</p></blockquote><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="line"><span class="token comment"># retention.ms=21600000 表示此设置topic 数据保存的时间，单位：毫秒，21600000 = 1000*60*60*6 = 6 小时</span></span>
<span class="line"><span class="token comment"># 线上可以提前写好 sh脚本，批量处理topic</span></span>
<span class="line"><span class="token function">sh</span> /home/hadoop/kafka_2.11-0.9.0.1/bin/kafka-configs.sh  <span class="token parameter variable">--zookeeper</span> <span class="token punctuation">{</span>zk配置地址<span class="token punctuation">}</span> <span class="token parameter variable">--alter</span> --add-config <span class="token string">&#39;retention.ms=21600000&#39;</span> --entity-type topics --entity-name <span class="token punctuation">{</span>topic_name<span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>观察<code>kafkaServer.out</code>日志，正常<code>broker</code>每5分钟触发一次删除任务，等看到日志中出现 <code>...delete...</code>日志，并且观察磁盘文件大小，已经变成预估空间大小，则说明已经删除完成</p></blockquote><h4 id="_2-停止kafka服务" tabindex="-1"><a class="header-anchor" href="#_2-停止kafka服务"><span>2.停止kafka服务</span></a></h4><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="line">./bin/kafka-server-stop.sh stop</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>观察日志，出现 <code>shutdown complete</code>字样的日志时，并且使用 <code>jps -m</code> 命令，找不到kafka的进程之后，表示停止完成</p><h4 id="_3-执行数据拷贝" tabindex="-1"><a class="header-anchor" href="#_3-执行数据拷贝"><span>3.执行数据拷贝</span></a></h4><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="line"><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /data3/kafka-logs</span>
<span class="line"><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /data4/kafka-logs</span>
<span class="line"><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /home/hadoop/kafka_2.11-0.9.0.1/logs</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 注意使用异步拷贝，防止当前shell窗口过期</span></span>
<span class="line"><span class="token function">nohup</span> <span class="token function">cp</span> <span class="token parameter variable">-r</span> /data1/kafka/var/kafka-logs/1/* /data3/kafka-logs/ <span class="token operator">&amp;</span></span>
<span class="line"><span class="token function">nohup</span> <span class="token function">cp</span> <span class="token parameter variable">-r</span> /data2/kafka/var/kafka-logs/1/* /data4/kafka-logs/ <span class="token operator">&amp;</span></span>
<span class="line"><span class="token comment"># 后续可以使用此命令，查看是否拷贝完成</span></span>
<span class="line"><span class="token function">ps</span> <span class="token parameter variable">-ef</span> <span class="token operator">|</span> <span class="token function">grep</span> kafka-logs</span>
<span class="line"><span class="token function">df</span> <span class="token parameter variable">-h</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>当观察到 新旧磁盘空间大小一致，且 <code>ps -ef | grep kafka-logs</code> 没有进程之后，说明拷贝完成</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="line"><span class="token comment"># 拷贝完成后，修改原目录名称</span></span>
<span class="line"><span class="token function">mv</span> /data1/kafka /data1/kafka_bak</span>
<span class="line"><span class="token function">mv</span> /data2/kafka /data2/kafka_bak</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_4-修改配置" tabindex="-1"><a class="header-anchor" href="#_4-修改配置"><span>4.修改配置</span></a></h4><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="line"><span class="token comment"># 修改kafka 配置文件</span></span>
<span class="line"><span class="token function">vim</span> /home/hadoop/kafka_2.11-0.9.0.1/config/server.properties</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 找到下面配置，并更改</span></span>
<span class="line"><span class="token assign-left variable">log.dirs</span><span class="token operator">=</span>/data3/kafka-logs,/data4/kafka-logs</span>
<span class="line"><span class="token assign-left variable">log.retention.hours</span><span class="token operator">=</span><span class="token number">72</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 修改gc日志配置，默认的会一直打印gc日志</span></span>
<span class="line"><span class="token function">vim</span> /home/hadoop/kafka_2.11-0.9.0.1/bin/kafka-run-class.sh</span>
<span class="line"><span class="token comment"># 找到下面配置，并更改</span></span>
<span class="line"><span class="token assign-left variable">KAFKA_GC_LOG_OPTS</span><span class="token operator">=</span><span class="token string">&quot; &quot;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_5-启动kafka服务" tabindex="-1"><a class="header-anchor" href="#_5-启动kafka服务"><span>5.启动kafka服务</span></a></h4><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="line">./bin/kafka-server-start.sh <span class="token parameter variable">-daemon</span> config/server.properties</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 观察日志：查看到启动完成，并且 集群中没有未同步副本时，说明此kafka已经完全启动</span></span>
<span class="line"><span class="token function">tail</span> <span class="token parameter variable">-f</span> ./logs/kafkaServer.out</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 观察旧的磁盘目录下，没有新文件产生，说明迁移成功</span></span>
<span class="line"><span class="token function">ls</span> <span class="token parameter variable">-lrth</span> /data1</span>
<span class="line"><span class="token function">ls</span> <span class="token parameter variable">-lrth</span> /data2</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_6-恢复topic存储时间" tabindex="-1"><a class="header-anchor" href="#_6-恢复topic存储时间"><span>6.恢复topic存储时间</span></a></h4><blockquote><p>千万不要忘了这一步。。。</p></blockquote><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="line"><span class="token function">sh</span> ./bin/kafka-configs.sh  <span class="token parameter variable">--zookeeper</span> <span class="token punctuation">{</span>zk配置地址<span class="token punctuation">}</span> <span class="token parameter variable">--alter</span> --delete-config <span class="token string">&#39;retention.ms&#39;</span> --entity-type topics --entity-name <span class="token punctuation">{</span>topic_name<span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h4 id="备注" tabindex="-1"><a class="header-anchor" href="#备注"><span>备注:</span></a></h4><ul><li>为什么要拷贝磁盘文件，而不是直接修改配置，重启kafka？ <ul><li>如果新的broker启动，加入集群，需要同步topic的数据；同步过程中，会占满带宽或磁盘IO，如果数据量过大，同步时间过长，会造成kakfa长时间不可用，线上数据淤积，影响业务</li><li>kakfa会在数据磁盘下生成：<code>recovery-point-offset-checkpoint</code>，<code>replication-offset-checkpoint</code>这俩文件，会记录当前磁盘下topic数据存储offset信息，拷贝过去之后会根据这俩文件同步数据，不会造成数据错乱问题</li><li>所以拷贝磁盘数据在数据量较大时，会是较优的方案</li></ul></li></ul>`,22)]))}const o=s(i,[["render",p],["__file","kafka_disk_migration.html.vue"]]),r=JSON.parse('{"path":"/blogs/jishu/kakfa/kafka_disk_migration.html","title":"Kafka-磁盘迁移","lang":"en-US","frontmatter":{"title":"Kafka-磁盘迁移","date":"2021-06-03T00:00:00.000Z","author":"shuiMu","categories":["技术"],"tags":["kafka"]},"headers":[{"level":3,"title":"磁盘迁移","slug":"磁盘迁移","link":"#磁盘迁移","children":[]}],"git":{"createdTime":1729235013000,"updatedTime":1729235013000,"contributors":[{"name":"peng.li","email":"lip.app@qq.com","commits":1}]},"filePathRelative":"blogs/技术/kakfa/kafka_disk_migration.md"}');export{o as comp,r as data};
